<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>VastVideo-Go - 聚合搜索无限精彩</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <!-- 引入 Google Fonts 美化标题 -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <!-- HLS.js 库 - 用于播放HLS流媒体 -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    html {
      scroll-behavior: auto;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* 全局移动端容器 */
    html, body {
      width: 100%;
      max-width: 100vw;
      overflow-x: hidden;
      /* 防止iOS缩放 */
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
      text-size-adjust: 100%;
      /* 防止iOS滚动回弹 */
      -webkit-overflow-scrolling: touch;
    }
    
    /* 确保所有容器都不会超出屏幕 */
    * {
      max-width: 100%;
    }
    
    /* 特别处理flex容器 */
    .flex-container {
      flex-wrap: wrap;
      width: 100%;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #18192b;
      color: #fff;
      line-height: 1.6;
      min-height: 100vh;
      width: 100%;
      box-sizing: border-box;
      overflow-x: hidden;
    }

    /* 悬浮置顶菜单栏 */
    .header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 52px;
      background: #23244a;
      z-index: 10000 !important;
      display: flex;
      align-items: center;
      padding: 0 16px;
      opacity: 1 !important;
      transition: none !important;
    }

    .menu-btn {
      width: 40px;
      height: 40px;
      background: #23244a;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      margin-right: 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .menu-btn:hover {
      background: #6c63ff;
      box-shadow: 0 2px 8px rgba(108,99,255,0.18);
    }
    .menu-btn span {
      width: 22px;
      height: 3px;
      background: #fff;
      border-radius: 2px;
      margin: 2.5px 0;
      display: block;
      transition: none;
      pointer-events: none;
    }

    .header-title {
      position: absolute; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.4rem; color: #fff; font-weight: 700;
      pointer-events: none;
    }

    /* 顶部菜单返回按钮 */
    .header .back-btn {
      width: 40px;
      height: 40px;
      background: #23244a;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      margin-left: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.2s;
      z-index: 10001;
      position: relative;
    }

    .header .back-btn:hover {
      background: #6c63ff;
      transform: scale(1.08);
    }

    .header .back-btn svg {
      width: 20px;
      height: 20px;
      stroke: #fff;
      stroke-width: 2.5;
      stroke-linecap: round;
      fill: none;
    }

    /* 关于按钮样式 */
    .header .about-btn {
      width: 40px;
      height: 40px;
      background: #23244a;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      margin-left: auto;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.2s;
      z-index: 10001;
      position: relative;
    }

    .header .about-btn:hover {
      background: #6c63ff;
      transform: scale(1.08);
    }

    .header .about-btn svg {
      width: 20px;
      height: 20px;
      stroke: #fff;
      stroke-width: 2.5;
      stroke-linecap: round;
      fill: none;
    }

    .header-logo {
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #6c63ff 60%, #ffd93d 100%);
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(108,99,255,0.12);
      margin-right: 6px;
    }
    .header-logo svg {
      width: 20px;
      height: 20px;
      display: block;
    }

    /* 侧边栏 */
    .sidebar {
      position: fixed;
      left: -280px; top: 0;
      width: 280px; height: 100vh;
      background: #23244a !important;
      z-index: 2001 !important;
      transition: left 0.3s cubic-bezier(0.4,0,0.2,1);
      overflow-y: auto;
    }

    .sidebar.active { left: 0; }

    .sidebar-mask {
      z-index: 2000 !important;
      display: none;
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(24,25,43,0.35);
      opacity: 1;
      transition: none;
    }

    .sidebar-mask.active { display: block; }

    .sidebar-header {
      padding: 20px 16px;
      border-bottom: 1px solid #3a3b5a;
      background: #2a2b4a;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }

    .search-container {
      padding: 16px;
      border-bottom: 1px solid #3a3b5a;
    }
    
    .search-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      padding-right: 40px; /* 为清空按钮留出空间 */
      border: 1px solid #3a3b5a;
      border-radius: 8px;
      font-size: 16px; /* 防止iOS自动放大，字体大小至少16px */
      outline: none;
      transition: border-color 0.3s;
      background: #18192b;
      color: #fff;
      -webkit-appearance: none; /* 移除iOS默认样式 */
      -webkit-border-radius: 8px; /* 确保圆角在iOS上生效 */
      border-radius: 8px;
      transform: translateZ(0); /* 启用硬件加速 */
    }

    .search-input:focus {
      border-color: #6c63ff;
      /* 防止iOS自动放大 */
      font-size: 16px !important;
      transform: translateZ(0);
    }
    
    .search-input::placeholder {
      color: #888;
    }
    
    .search-clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      color: #b3b6d4;
    }
    
    .search-clear-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      transform: translateY(-50%) scale(1.1);
    }
    
    .search-clear-btn:active {
      transform: translateY(-50%) scale(0.95);
    }
    
    .search-clear-btn svg {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }

    .search-btn {
      width: 100%;
      padding: 12px;
      background: #6c63ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.3s;
    }

    .search-btn:hover {
      background: #554eea;
    }

    /* 筛选选项 */
    .filter-section {
      padding: 16px;
      border-bottom: 1px solid #3a3b5a;
    }

    .filter-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 12px;
    }

    .filter-tabs {
      display: flex;
      background: #18192b;
      border-radius: 8px;
      padding: 4px;
      margin-bottom: 16px;
    }

    .filter-tab {
      flex: 1;
      padding: 8px 12px;
      background: none;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s;
      color: #b3b6d4;
    }

    .filter-tab.active {
      background: #6c63ff;
      color: #fff;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag-btn {
      padding: 6px 12px;
      background: #23244a;
      border: none;
      border-radius: 16px;
      font-size: 12px;
      color: #b3b6d4;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tag-btn.active {
      background: #6c63ff;
      color: #fff;
    }

    /* 遮罩层 */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
      pointer-events: none;
    }

    .overlay.active {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    /* 切换开关样式 */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #444;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-switch input:checked + .toggle-slider {
      background: #6c63ff;
    }

    .toggle-switch input:checked + .toggle-slider {
      transform: translateX(20px);
    }

    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* 开关悬停效果 */
    .toggle-switch:hover .toggle-slider {
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .toggle-switch:active .toggle-slider {
      transform: scale(0.95);
    }

    /* 主内容区 */
    .main-content {
      margin-top: 72px; /* 加大顶部菜单与内容区的间距，更舒适 */
      padding: 8px;
      padding-top: 0;
      min-height: calc(100vh - 60px);
      z-index: 0 !important;
      width: 100%;
      box-sizing: border-box;
      overflow-x: hidden;
    }

    /* 豆瓣推荐区 */
    #recommendSectionMobile {
      position: relative;
      z-index: 1000;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 16px;
    }

    /* 视频卡片网格 */
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
    }

    .video-card {
      background: #23244a;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }

    .video-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(108,99,255,0.18);
    }
    
    .video-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(108,99,255,0.1) 0%, rgba(108,99,255,0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 1;
    }
    
    .video-card:hover::before {
      opacity: 1;
    }

    .video-cover {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      background: #18192b;
      display: block;
      transition: opacity 0.3s ease;
    }
    
    .video-cover.loading {
      opacity: 0.7;
    }
    
    .video-cover.loaded {
      opacity: 1;
    }

    .video-info {
      padding: 12px;
    }

    .video-title {
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      margin-bottom: 8px;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .video-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .meta-badge {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }

    .meta-badge.type {
      background: #ff6b6b;
      color: #fff;
    }

    .meta-badge.rate {
      background: #ffd93d;
      color: #333;
    }

    .meta-badge.year {
      background: #6bcf7f;
      color: #fff;
    }

    .meta-badge.tag {
      background: #23244a;
      color: #b3b6d4;
    }

    /* 加载状态 */
    .loading {
      text-align: center;
      padding: 20px 16px;
      color: #b3b6d4;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #3a3b5a;
      border-top: 2px solid #6c63ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 8px;
    }

    /* 通用加载卡片样式 */
    .loading-card {
      background: #23244a;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 280px;
      border: 2px dashed #3a3b5a;
    }
    .loading-card .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #3a3b5a;
      border-top: 3px solid #6c63ff;
      margin-bottom: 12px;
    }
    .loading-card .loading-text {
      font-size: 14px;
      color: #b3b6d4;
      font-weight: 500;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 无结果状态 */
    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: #b3b6d4;
    }

    .no-results-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* 加载更多 */
    .load-more {
      text-align: center;
      padding: 20px;
      color: #b3b6d4;
    }

    .load-more-btn {
      padding: 12px 24px;
      background: #6c63ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .load-more-btn:hover {
      background: #554eea;
    }

    .load-more-btn:disabled {
      background: #3a3b5a;
      cursor: not-allowed;
    }

    /* 响应式调整 */
    @media (max-width: 480px) {
      .video-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 8px;
      }

      .video-info {
        padding: 8px;
      }

      .video-title {
        font-size: 13px;
      }

      .meta-badge {
        font-size: 9px;
        padding: 1px 4px;
      }
      
      .loading {
        padding: 16px 12px;
        min-height: 100px;
      }
      
      .loading-spinner {
        width: 18px;
        height: 18px;
        margin: 0 auto 6px;
      }
      
      .loading-card {
        min-height: 240px;
      }
      
      .loading-card .loading-spinner {
        width: 28px;
        height: 28px;
        border: 2px solid #3a3b5a;
        border-top: 2px solid #6c63ff;
        margin-bottom: 10px;
      }
      
      .loading-card .loading-text {
        font-size: 13px;
      }
    }
    
    /* 小屏幕移动端优化 */
    @media (max-width: 768px) {
      /* 小屏幕时恢复垂直布局 */
      .player-content {
        flex-direction: column;
        gap: 12px;
      }
      
      .player-main-section,
      .video-info-sidebar {
        flex: none;
        width: 100%;
      }
      
      /* 小屏幕时显示原来的视频信息卡片，隐藏侧边栏 */
      .video-info-card {
        display: block;
      }
      
      .video-info-sidebar {
        display: none;
      }
      
      .video-info-card-sidebar {
        position: static;
        margin-bottom: 12px;
      }
      
      .video-cover-sidebar {
        height: 150px;
      }
      
      .video-title-sidebar {
        font-size: 14px;
      }
      
      .meta-badge-sidebar {
        font-size: 10px;
        padding: 3px 6px;
      }
      
      .video-description-text-sidebar {
        font-size: 12px;
        -webkit-line-clamp: 4;
      }
    }
    
    @media (max-width: 480px) {
      .main-content {
        padding: 6px;
      }
      
      .video-info-card {
        padding: 10px;
      }
      
      .episode-section {
        padding: 12px 8px 8px 8px;
      }
      
      .episode-btn {
        padding: 6px 10px;
        font-size: 12px;
        margin: 3px;
      }
      
      .episode-tab {
        padding: 5px 12px;
        font-size: 12px;
      }
      
      .video-cover-large {
        width: 70px;
        height: 105px;
      }
      
      .video-title-large {
        font-size: 16px;
      }
      
      .meta-badge-large {
        padding: 3px 6px;
        font-size: 11px;
      }
      
      .video-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 8px;
      }
      
      .video-title {
        font-size: 12px;
      }
      
      .video-info {
        padding: 8px;
      }
      
      /* 超小屏幕进一步优化侧边栏 */
      .video-info-card-sidebar {
        padding: 12px;
      }
      
      .video-cover-sidebar {
        height: 120px;
      }
      
      .video-title-sidebar {
        font-size: 13px;
        margin-bottom: 8px;
      }
      
      .video-meta-sidebar {
        gap: 4px;
        margin-bottom: 8px;
      }
      
      .meta-badge-sidebar {
        font-size: 9px;
        padding: 2px 4px;
      }
      
      .video-description-text-sidebar {
        font-size: 11px;
        -webkit-line-clamp: 3;
      }
    }
    
    /* 超小屏幕优化 */
    @media (max-width: 360px) {
      .main-content {
        padding: 4px;
      }
      
      .video-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 6px;
      }
      
      .video-info-card {
        padding: 8px;
      }
      
      .episode-section {
        padding: 10px 6px 6px 6px;
      }
      
      .episode-btn {
        padding: 5px 8px;
        font-size: 11px;
        margin: 2px;
      }
      
      .video-cover-large {
        width: 60px;
        height: 90px;
      }
      
      .video-title-large {
        font-size: 14px;
      }
    }

    /* 自定义滚动条样式 */
    #sourcesListSidebar::-webkit-scrollbar {
      width: 6px;
    }
    
    #sourcesListSidebar::-webkit-scrollbar-track {
      background: rgba(24,25,43,0.3);
      border-radius: 3px;
    }
    
    #sourcesListSidebar::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #6c63ff, #8b5cf6);
      border-radius: 3px;
      transition: background 0.2s ease;
    }
    
    #sourcesListSidebar::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #554eea, #7c3aed);
    }
    
    /* Firefox滚动条样式 */
    #sourcesListSidebar {
      scrollbar-width: thin;
      scrollbar-color: #6c63ff rgba(24,25,43,0.3);
    }
    
    /* PC分辨率下的样式 */
    @media (min-width: 769px) {
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .video-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
      }
      
      .video-card {
        max-width: 250px;
      }
      
      .video-title {
        font-size: 16px;
      }
      
      .meta-badge {
        font-size: 12px;
        padding: 3px 8px;
      }
      
      .section-title {
        font-size: 24px;
        margin-bottom: 24px;
      }
      
      .main-content {
        padding: 24px;
      }
    }

    /* 确保内容可见 */
    .main-content {
      display: block !important;
    }

    .video-grid {
      display: grid !important;
    }

    #searchResultsMobile {
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.25s;
      will-change: transform, opacity;
      position: relative;
      z-index: 2000;
    }
    #searchResultsMobile.slide-out {
      transform: translateX(100vw);
      opacity: 0;
      pointer-events: none;
    }
    #searchResultsMobile.slide-in {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }

    /* 播放层滑动效果 */
    #playerLayerMobile {
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.25s;
      will-change: transform, opacity;
      position: relative;
      z-index: 2000;
    }
    #playerLayerMobile.slide-out {
      transform: translateX(100vw);
      opacity: 0;
      pointer-events: none;
    }
    #playerLayerMobile.slide-in {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }
    
    /* 播放层实时滑动效果 */
    #playerLayerMobile.sliding {
      transition: transform 0.1s ease-out;
    }

    /* 源分隔符样式 */
    .source-divider {
      grid-column: 1/-1;
      padding: 16px 0 8px 0;
      border-top: 1px solid #3a3b5a;
      margin-top: 16px;
    }
    
    .source-title {
      font-size: 14px;
      font-weight: 600;
      color: #6c63ff;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .source-title::before {
      content: '';
      width: 4px;
      height: 16px;
      background: #6c63ff;
      border-radius: 2px;
    }
    
    .source-title-large {
      font-size: 16px;
      font-weight: 600;
      color: #6c63ff;
      padding: 8px 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .source-title-large::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #6c63ff;
      border-radius: 2px;
    }

    /* 友好提示样式 */
    .toast {
      background: rgba(35, 36, 74, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(108, 99, 255, 0.2);
      border-radius: 12px;
      padding: 12px 20px;
      margin-bottom: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 300px;
      word-wrap: break-word;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: auto;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      border-color: rgba(107, 207, 127, 0.3);
      background: rgba(35, 36, 74, 0.95);
    }

    .toast.warning {
      border-color: rgba(255, 214, 61, 0.3);
      background: rgba(35, 36, 74, 0.95);
    }

    .toast.error {
      border-color: rgba(255, 107, 107, 0.3);
      background: rgba(35, 36, 74, 0.95);
    }

    .toast.info {
      border-color: rgba(108, 99, 255, 0.3);
      background: rgba(35, 36, 74, 0.95);
    }

    /* 播放器相关样式 */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .ep-btn-mobile {
      background: #23244a;
      color: #b3b6d4;
      border: none;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ep-btn-mobile:hover,
    .ep-btn-mobile.active {
      background: #6c63ff;
      color: #fff;
      transform: translateY(-1px);
    }

    .ep-btn-mobile.episode-loading {
      opacity: 0.6;
      cursor: wait;
    }
    
    .type-filter-btn-mobile {
      background: #23244a;
      color: #b3b6d4;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .type-filter-btn-mobile:hover {
      background: #6c63ff;
      color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(108,99,255,0.3);
    }
    
    .type-filter-btn-mobile.active {
      background: #6c63ff;
      color: #fff;
      box-shadow: 0 2px 8px rgba(108,99,255,0.3);
    }

    .mobile-toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(35, 36, 74, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(108, 99, 255, 0.2);
      border-radius: 12px;
      padding: 12px 20px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      max-width: 300px;
      word-wrap: break-word;
      opacity: 0;
      transform: translateX(-50%) translateY(-20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 10001;
    }

    .mobile-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .mobile-toast.success {
      border-color: rgba(107, 207, 127, 0.3);
    }

    .mobile-toast.warning {
      border-color: rgba(255, 214, 61, 0.3);
    }

    .mobile-toast.error {
      border-color: rgba(255, 107, 107, 0.3);
    }

    .mobile-toast.info {
      border-color: rgba(108, 99, 255, 0.3);
    }

    /* 播放器控制按钮样式 */
    #playerControlsMobile button {
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    #playerControlsMobile button:hover {
      background: rgba(108, 99, 255, 0.8) !important;
      transform: scale(1.1);
    }

    /* 侧边栏关闭按钮样式 */
    #closeSidebarBtn {
      backdrop-filter: blur(10px);
      transition: all 0.2s ease;
    }

    #closeSidebarBtn:hover {
      background: rgba(108,99,255,0.8) !important;
      color: #fff !important;
      transform: scale(1.1);
    }

    /* 播放层样式 - 全新设计 */
    #playerLayerMobile {
      display: none;
      width: 100%;
      box-sizing: border-box;
      background: #18192b;
      min-height: 100vh;
      position: relative;
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.25s;
      will-change: transform, opacity;
      z-index: 2000;
    }
    
    #playerLayerMobile.active {
      display: block;
    }
    
    #playerLayerMobile.slide-out {
      transform: translateX(100vw);
      opacity: 0;
      pointer-events: none;
    }
    
    #playerLayerMobile.slide-in {
      transform: translateX(0);
      opacity: 1;
      pointer-events: auto;
    }
    
    /* 播放层实时滑动效果 */
    #playerLayerMobile.sliding {
      transition: transform 0.1s ease-out;
    }
    
    /* 播放层容器 */
    .player-layer-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }
    
    /* 播放层头部 */
    .player-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid #3a3b5a;
    }
    
    .player-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 1;
      min-width: 0;
    }
    
    .player-header-cover {
      width: 80px;
      height: 120px;
      object-fit: cover;
      border-radius: 12px;
      background: #23244a;
      flex-shrink: 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .player-header-info {
      flex: 1;
      min-width: 0;
    }
    
    .player-header-title {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
      line-height: 1.3;
      word-break: break-word;
    }
    
    .player-header-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .player-header-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .player-header-badge.source {
      background: linear-gradient(135deg, #6c63ff 0%, #5a52d5 100%);
      color: #fff;
    }
    
    .player-header-badge.type {
      background: linear-gradient(135deg, #ff6b6b 0%, #e74c3c 100%);
      color: #fff;
    }
    
    .player-header-badge.rate {
      background: linear-gradient(135deg, #ffd93d 0%, #f39c12 100%);
      color: #333;
    }
    
    .player-header-badge.year {
      background: linear-gradient(135deg, #6bcf7f 0%, #27ae60 100%);
      color: #fff;
    }
    
    .player-header-badge.resolution {
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
      color: #fff;
    }
    
    .player-header-actions {
      display: flex;
      gap: 12px;
      flex-shrink: 0;
    }
    
    .player-action-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: #23244a;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .player-action-btn:hover {
      background: #6c63ff;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(108,99,255,0.3);
    }
    
    .player-action-btn svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      stroke-width: 2;
      fill: none;
    }
    
    /* 播放层主体内容 */
    .player-main-content {
      display: grid;
      gap: 24px;
      grid-template-columns: 1fr;
    }
    
    /* PC端布局 */
    @media (min-width: 1024px) {
      .player-main-content {
        grid-template-columns: 2fr 1fr;
        gap: 32px;
      }
      
      .player-header-title {
        font-size: 28px;
      }
      
      .player-header-cover {
        width: 100px;
        height: 150px;
      }
      
      /* PC端播放器区域固定宽度 */
      .player-video-section {
        width: 100%;
        max-width: 100%;
        flex-shrink: 0;
      }
    }
    
    /* 播放器区域 */
    .player-video-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
      /* 确保播放器区域位置固定 */
      position: relative;
      /* 确保宽度固定，不受父容器影响 */
      width: 100%;
      max-width: 100%;
      flex-shrink: 0;
    }
    
    /* 播放器容器 - 固定宽度和位置，只调整高度 */
    .player-container {
      position: relative;
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #18192b;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      border: 1px solid rgba(108,99,255,0.1);
      min-height: 220px;
      max-height: 70vh; /* 限制最大高度，避免竖版视频过高 */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: height 0.3s ease; /* 只添加高度变化动画 */
      /* 确保容器位置固定，不受内容影响 */
      position: relative;
      left: 0;
      top: 0;
    }
    
    /* 视频播放器 - 固定宽度和位置，只调整高度 */
    #playerVideoMobile {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
      margin: 0;
      background: #000;
      border-radius: 16px;
      /* 确保视频内容居中显示，位置固定 */
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    
    /* 竖版视频特殊处理 - 保持容器尺寸固定，只调整高度 */
    #playerVideoMobile[data-aspect-ratio="portrait"] {
      width: 100%;
      height: 100%;
      max-width: 100%;
      max-height: 100%;
      margin: 0;
    }
    /* 剧集按钮横向文字显示 */
    .episode-btn {
      writing-mode: horizontal-tb !important;
      text-orientation: mixed !important;
      letter-spacing: 0 !important;
      word-break: keep-all !important;
      white-space: nowrap !important;
      text-align: center;
    }
    
    /* iframe播放器 */
    #playerIframeMobile {
      width: 100%;
      aspect-ratio: 16/9;
      display: none;
      border: none;
      border-radius: 16px;
      background: #000;
    }
    
    /* 加载和错误状态 */
    #videoLoadingMobile,
    #videoErrorMobile {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      text-align: center;
      background: rgba(24,25,43,0.9);
      backdrop-filter: blur(10px);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid rgba(108,99,255,0.2);
    }
    
    #videoLoadingMobile {
      color: #b3b6d4;
      font-size: 16px;
    }
    
    #videoErrorMobile {
      color: #ff6b6b;
      font-size: 16px;
    }
    
    /* 剧集选择区域 */
    .episode-section {
      background: linear-gradient(135deg, #23244a 0%, #2a2b4a 100%);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      border: 1px solid rgba(108,99,255,0.1);
    }
    
    .episode-section-title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .episode-section-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #6c63ff;
      border-radius: 2px;
    }
    
    .episode-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      padding: 6px;
      background: rgba(24,25,43,0.5);
      border-radius: 12px;
      border: 1px solid rgba(108,99,255,0.1);
    }
    
    .episode-tab {
      position: relative;
      padding: 8px 16px;
      border-radius: 8px;
      background: transparent;
      color: #b3b6d4;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      text-align: center;
    }
    
    .episode-tab:hover {
      background: rgba(108,99,255,0.1);
      color: #fff;
    }
    
    .episode-tab.active {
      background: #6c63ff;
      color: #fff;
      box-shadow: 0 4px 12px rgba(108,99,255,0.3);
    }
    
    .episode-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
      padding-right: 8px;
    }
    
    .episode-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .episode-list::-webkit-scrollbar-track {
      background: rgba(24,25,43,0.3);
      border-radius: 3px;
    }
    
    .episode-list::-webkit-scrollbar-thumb {
      background: rgba(108,99,255,0.5);
      border-radius: 3px;
    }
    
    .episode-btn {
      position: relative;
      padding: 12px 8px;
      border-radius: 8px;
      background: rgba(24,25,43,0.5);
      color: #b3b6d4;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      word-break: break-word;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .episode-btn:hover {
      background: rgba(108,99,255,0.1);
      color: #fff;
      border-color: rgba(108,99,255,0.3);
      transform: translateY(-1px);
    }
    
    .episode-btn.active {
      background: #6c63ff;
      color: #fff;
      border-color: #6c63ff;
      box-shadow: 0 4px 12px rgba(108,99,255,0.3);
    }
    
    .episode-btn.active::after {
      content: '▶';
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 10px;
      opacity: 0.8;
    }
    
    /* 侧边栏区域 */
    .player-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* 视频信息卡片 */
    .video-info-card {
      background: linear-gradient(135deg, #23244a 0%, #2a2b4a 100%);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      border: 1px solid rgba(108,99,255,0.1);
    }
    
    .video-info-title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .video-info-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #6c63ff;
      border-radius: 2px;
    }

    .video-description-text {
      font-size: 14px;
      line-height: 1.6;
      color: #b3b6d4;
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 8;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-word;
      text-indent: 1em;
      white-space: pre-wrap;
    }
    
    .video-description-text.expanded {
      -webkit-line-clamp: unset;
      max-height: none;
    }
    
    .video-description-toggle {
      background: none;
      border: none;
      color: #6c63ff;
      font-size: 13px;
      cursor: pointer;
      padding: 8px 16px;
      margin-top: 12px;
      border-radius: 6px;
      transition: all 0.2s;
      font-weight: 600;
    }
    
    .video-description-toggle:hover {
      color: #554eea;
      background: rgba(108,99,255,0.1);
    }
    
    /* 演员信息区域 */
    .cast-section {
      background: linear-gradient(135deg, #23244a 0%, #2a2b4a 100%);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      border: 1px solid rgba(108,99,255,0.1);
    }
    
    .cast-title {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .cast-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: #6c63ff;
      border-radius: 2px;
    }

    .cast-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 16px;
    }
    
    .cast-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .cast-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      background: #18192b;
      margin-bottom: 8px;
      border: 2px solid #3a3b5a;
      transition: all 0.3s ease;
    }
    
    .cast-card:hover .cast-avatar {
      border-color: #6c63ff;
      transform: scale(1.05);
    }
    
    .cast-name {
      font-size: 12px;
      color: #fff;
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 80px;
    }
    
    .cast-role {
      font-size: 11px;
      color: #b3b6d4;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 80px;
    }
    
    /* 移动端优化 */
    @media (max-width: 1023px) {
      .player-layer-container {
        padding: 16px;
      }
      
      .player-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .player-header-left {
        width: 100%;
      }
      
      .player-header-actions {
        width: 100%;
        justify-content: flex-end;
      }
      
      .player-header-title {
        font-size: 20px;
      }
      
      .player-header-cover {
        width: 70px;
        height: 105px;
      }
      
      .episode-list {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        max-height: 250px;
      }
      
      .cast-list {
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 12px;
      }
      
      .cast-avatar {
        width: 50px;
        height: 50px;
      }
      
      /* 移动端播放器容器优化 */
      .player-container {
        min-height: 180px;
        max-height: 60vh; /* 移动端限制更严格 */
      }
    }
    
    /* 超小屏幕优化 */
    @media (max-width: 480px) {
      .player-layer-container {
        padding: 12px;
      }
      
      .player-header-title {
        font-size: 18px;
      }
      
      .player-header-cover {
        width: 60px;
        height: 90px;
      }
      
      .episode-list {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 6px;
      }
      
      .episode-btn {
        padding: 10px 6px;
        font-size: 12px;
        min-height: 40px;
      }
      
      .cast-list {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 8px;
      }
      
      .cast-avatar {
        width: 45px;
        height: 45px;
      }
      
      .cast-name {
        font-size: 11px;
        max-width: 60px;
      }
      
      .cast-role {
        font-size: 10px;
        max-width: 60px;
      }
    }
  </style>
</head>
<body>
  <!-- 顶部菜单栏 -->
  <header class="header">
    <button class="menu-btn" id="menuBtn">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <h1 class="header-title" id="headerTitle" style="font-family:'Montserrat',sans-serif;font-size:1.6rem;letter-spacing:1.5px;cursor:pointer;transition:color 0.2s;">VastVideo-Go</h1>
    <button class="about-btn" id="aboutBtn" aria-label="关于" title="关于 VastVideo-Go">
      <svg viewBox="0 0 24 24" width="20" height="20">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" stroke="currentColor" stroke-width="2" fill="none"/>
        <line x1="12" y1="17" x2="12.01" y2="17" stroke="currentColor" stroke-width="2"/>
      </svg>
    </button>
    <button class="back-btn" id="globalBackBtn" aria-label="返回" style="display: none;">
      <svg viewBox="0 0 24 24">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </button>
  </header>

  <!-- 侧边栏 -->
  <aside class="sidebar" id="sidebar">
    <button id="closeSidebarBtn" class="close-btn" aria-label="关闭侧边栏">
      <svg viewBox="0 0 24 24">
        <line x1="6" y1="6" x2="18" y2="18"/>
        <line x1="18" y1="6" x2="6" y2="18"/>
      </svg>
    </button>
    <div class="search-container" style="margin-top: 60px;">
      <div class="search-input-wrapper">
      <input type="text" class="search-input" id="searchInput" placeholder="关键字或直接搜索返回最新" style="color: #fff;">
        <button class="search-clear-btn" id="searchClearBtn" style="display: none;" title="清空搜索">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <button class="search-btn" id="searchBtn">搜索</button>
    </div>

    <div class="filter-section">
      <h3 class="filter-title">豆瓣内容类别</h3>
      <div class="filter-tabs">
        <button class="filter-tab active" id="movieTab">电影</button>
        <button class="filter-tab" id="tvTab">电视剧</button>
      </div>
    </div>

    <div class="filter-section">
      <h3 class="filter-title">豆瓣内容标签</h3>
      <div class="tags-container" id="tagsContainer">
        <span class="loading">加载中...</span>
      </div>
    </div>
    <div class="filter-section" style="border-bottom:none;position:relative;">
      <button id="toggleSourceSelectionBtn" style="width:100%;background:#23244a;color:#b3b6d4;border:none;border-radius:8px;padding:12px 0;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:12px;">视频源选择</button>
      <button id="filterSettingsBtn" style="width:100%;background:#23244a;color:#b3b6d4;border:none;border-radius:8px;padding:12px 0;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:12px;">过滤设置</button>
    </div>
    
    <!-- 过滤设置区域 -->
    <div id="filterSettingsArea" style="display:none;border-top:1px solid #3a3b5a;padding:16px;">
      <!-- 密码输入界面 -->
      <div id="passwordSection" style="margin-bottom:16px;">
        <h4 style="color:#fff;margin-bottom:12px;font-size:14px;">管理员验证</h4>
        <div style="margin-bottom:12px;">
          <input type="password" id="adminPassword" placeholder="请输入管理员密码" style="width:100%;padding:12px;border:1px solid #3a3b5a;border-radius:8px;background:#18192b;color:#fff;font-size:14px;outline:none;box-sizing:border-box;">
        </div>
        <div style="display:flex;gap:8px;">
          <button id="submitPassword" style="flex:1;background:#6c63ff;color:#fff;border:none;border-radius:6px;padding:8px;font-size:12px;cursor:pointer;">确认</button>
          <button id="cancelPassword" style="flex:1;background:#444;color:#fff;border:none;border-radius:6px;padding:8px;font-size:12px;cursor:pointer;">取消</button>
        </div>
      </div>
      
      <!-- 过滤设置界面 -->
      <div id="filterSettingsSection" style="display:none;">
        <h4 style="color:#fff;margin-bottom:12px;font-size:14px;">内容过滤</h4>
        <div style="margin-bottom:16px;">
          <label style="display:flex;align-items:center;justify-content:space-between;color:#fff;font-size:13px;margin-bottom:8px;">
            <span>隐藏成人内容</span>
            <div class="toggle-switch">
              <input type="checkbox" id="adultContentToggle" style="display:none;">
              <span class="toggle-slider"></span>
            </div>
          </label>
          <p style="color:#b3b6d4;font-size:11px;margin:0;">开启后将隐藏伦理片、理论片类型的内容</p>
        </div>
        
        <div style="margin-bottom:16px;">
          <label style="display:flex;align-items:center;justify-content:space-between;color:#fff;font-size:13px;margin-bottom:8px;">
            <span>修改管理员密码</span>
            <button id="changePasswordBtn" style="background:#444;color:#fff;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;">修改</button>
          </label>
        </div>
        
        <div id="changePasswordSection" style="display:none;margin-bottom:16px;">
          <input type="password" id="newPassword" placeholder="新密码" style="width:100%;padding:10px;border:1px solid #3a3b5a;border-radius:6px;background:#18192b;color:#fff;font-size:13px;outline:none;box-sizing:border-box;margin-bottom:8px;">
          <input type="password" id="confirmPassword" placeholder="确认新密码" style="width:100%;padding:10px;border:1px solid #3a3b5a;border-radius:6px;background:#18192b;color:#fff;font-size:13px;outline:none;box-sizing:border-box;">
        </div>
        
        <div style="display:flex;gap:8px;">
          <button id="saveFilterSettings" style="flex:1;background:#6c63ff;color:#fff;border:none;border-radius:6px;padding:8px;font-size:12px;cursor:pointer;">保存设置</button>
          <button id="closeFilterSettings" style="flex:1;background:#444;color:#fff;border:none;border-radius:6px;padding:8px;font-size:12px;cursor:pointer;">关闭</button>
        </div>
      </div>
    </div>
  <!-- 在aside末尾插入覆盖层 -->
  <div id="sourceSelectionArea" style="display:none;position:absolute;top:0;left:0;right:0;bottom:0;background:#23244a;z-index:1000;padding:16px;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:600;color:#fff;">选择视频源</div>
      <button id="closeSourceSelectionBtn" style="background:none;color:#b3b6d4;border:none;font-size:20px;cursor:pointer;padding:4px;">×</button>
    </div>
    <div id="sourcesListSidebar" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding-bottom:4px;"></div>
    <div style="display:flex;justify-content:space-between;gap:10px;margin-bottom:12px;">
      <button id="selectAllBtnSidebar" style="flex:1;background:#6c63ff;color:#fff;border:none;border-radius:8px;padding:8px 0;font-size:14px;font-weight:600;cursor:pointer;">全选</button>
      <button id="invertSelectBtnSidebar" style="flex:1;background:#444;color:#fff;border:none;border-radius:8px;padding:8px 0;font-size:14px;font-weight:600;cursor:pointer;">反选</button>
    </div>
    <button id="saveSourcesBtnSidebar" style="width:100%;background:#6c63ff;color:#fff;border:none;border-radius:8px;padding:10px 0;font-size:14px;font-weight:600;cursor:pointer;">保存选择</button>
    </div>
  </aside>
  <!-- 遮罩层，必须紧跟在sidebar后面，且为body直接子元素 -->
  <div class="sidebar-mask" id="sidebarMask"></div>

  <!-- 遮罩层 -->
  <div class="overlay" id="overlay"></div>





  <!-- 主内容区 -->
  <main class="main-content">
    <!-- 推荐区 -->
    <div id="recommendSectionMobile" style="width:100%;box-sizing:border-box;">
      <div id="recommendHeaderMobile">
        <h2 class="section-title">
          豆瓣最新推荐
          <span id="currentCategory" style="font-size:15px;font-weight:400;color:#b3b6d4;margin-left:12px;"></span>
        </h2>
      </div>
      <div class="video-grid" id="videoGrid"></div>
      <div class="load-more" id="loadMore">
        <button class="load-more-btn" id="loadMoreBtn">加载更多</button>
      </div>
    </div>
    
    <!-- 搜索结果区 -->
    <div id="searchResultsMobile" style="display:none;width:100%;box-sizing:border-box;">
      <header id="searchHeaderMobile" style="margin-bottom:16px;"></header>
      <div class="video-grid" id="searchGridMobile"></div>
    </div>

    <!-- 播放层（与其它区同级） -->
    <div id="playerLayerMobile" style="display:none;width:100%;box-sizing:border-box;">
      <div class="player-layer-container">
        <!-- 播放层头部 -->
        <div class="player-header">
          <div class="player-header-left">
            <img class="player-header-cover" id="playerVideoCoverHeader" src="" alt="视频封面">
            <div class="player-header-info">
              <h1 class="player-header-title" id="playerVideoTitleHeader">视频标题</h1>
              <div class="player-header-meta" id="playerVideoMetaHeader">
                <!-- 视频源、分类、评分等标签 -->
      </div>
            </div>
          </div>
          <div class="player-header-actions">
            <button class="player-action-btn" onclick="toggleFullscreen()" title="全屏">
              <svg viewBox="0 0 24 24">
                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
              </svg>
            </button>
            <button class="player-action-btn" onclick="hidePlayerLayer()" title="关闭">
              <svg viewBox="0 0 24 24">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
    </div>
  </div>

        <!-- 播放层主体内容 -->
        <div class="player-main-content">
          <!-- 播放器区域 -->
          <div class="player-video-section">
            <!-- 播放器容器 -->
            <div class="player-container">
      <!-- 视频播放器 -->
      <video id="playerVideoMobile" 
             controls 
             preload="metadata" 
                     style="width:100%;aspect-ratio:16/9;display:none;"
                     onerror="handleMobileVideoError(this)"
                     onloadstart="handleMobileVideoLoadStart(this)"
                     oncanplay="handleMobileVideoCanPlay(this)"
             playsinline 
             webkit-playsinline="true"
             x-webkit-airplay="allow"
             webkit-airplay="allow"
                     airplay="allow"
                     x-webkit-airplay="allow"
                     webkit-airplay="allow"
                     onwebkitbeginfullscreen="handleAirPlayFullscreen(this)"
                     onwebkitendfullscreen="handleAirPlayEndFullscreen(this)"
                     onwebkitpresentationmodechanged="handleAirPlayModeChanged(this)">
      </video>
      
      <!-- iframe播放器 -->
      <iframe id="playerIframeMobile" 
              src="about:blank" 
                      style="width:100%;aspect-ratio:16/9;display:none;border:none;">
      </iframe>
      
      <!-- 加载状态 -->
              <div id="videoLoadingMobile" style="display:none;">
                <div style="text-align:center;">
        <div style="width:40px;height:40px;border:3px solid #6c63ff;border-top:3px solid transparent;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px;"></div>
        正在加载视频...
                </div>
      </div>
      
      <!-- 错误状态 -->
              <div id="videoErrorMobile" style="display:none;">
        <div style="margin-bottom:12px;">⚠️ 视频加载失败</div>
                <button onclick="retryMobileVideo()" style="background:#6c63ff;color:#fff;border:none;border-radius:6px;padding:8px 16px;cursor:pointer;">重试</button>
              </div>
      </div>
      
            <!-- 剧集选择区域 -->
            <div class="episode-section">
              <div class="episode-section-title">剧集选择</div>
              <div class="episode-tabs">
                <button class="episode-tab active" id="tabStream">流媒体</button>
                <button class="episode-tab" id="tabPage">页面源</button>
      </div>
              <div class="episode-list" id="episodeListStream">
                <!-- 流媒体剧集按钮列表（JS填充）-->
    </div>
              <div class="episode-list" id="episodeListPage" style="display:none;">
                <!-- 页面源剧集按钮列表（JS填充）-->
              </div>
            </div>
        </div>
        
          <!-- 侧边栏区域 -->
          <div class="player-sidebar">
            <!-- 视频信息卡片 -->
            <div class="video-info-card">
              <div class="video-info-title">视频介绍</div>
              <div class="video-description-text" id="playerVideoDescription">
                <!-- 视频介绍信息 -->
          </div>
              <button class="video-description-toggle" onclick="toggleDescription()" style="display:none;">展开更多</button>
        </div>
        
            <!-- 演员信息区域 -->
            <div class="cast-section">
              <div class="cast-title">演员信息</div>
              <div class="cast-list" id="castList">
                <!-- 人员头像卡片（JS填充）-->
        </div>
      </div>
    </div>
  </div>
      </div>
    </div>
  </main>



  <!-- 友好提示组件 -->
  <div id="toastContainer" style="position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:9999;pointer-events:none;"></div>

  <!-- 移动端提示容器 -->
  <div id="mobileToastContainer" style="position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:10001;pointer-events:none;"></div>

  <script>
    // 友好提示函数
    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      // 触发动画
      setTimeout(() => {
        toast.classList.add('show');
      }, 10);
      
      // 自动移除
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    // 安全的图片处理函数
    function getSafeImageUrl(url) {
      try {
        if (!url || typeof url !== 'string') {
          return getDefaultSvgUrl();
        }
        
        const trimmedUrl = url.trim();
        if (!trimmedUrl || trimmedUrl.includes('placeholder.com')) {
          return getDefaultSvgUrl();
        }
        
        return trimmedUrl;
      } catch (error) {
        console.error('图片URL处理错误:', error);
        return getDefaultSvgUrl();
      }
    }
    
    function getDefaultSvgUrl() {
      return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQwIiBoZWlnaHQ9IjIxMCIgdmlld0JveD0iMCAwIDE0MCAyMTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNDAiIGhlaWdodD0iMjEwIiBmaWxsPSIjMjMyNDRhIi8+CjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxNjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzNjM2M1YSIgc3Ryb2tlLXdpZHRoPSIxIi8+CjxwYXRoIGQ9Ik0zMCA2MGg4MHY0MEgzMHoiIGZpbGw9IiMzYzNjNWEiIGZpbGwtb3BhY2l0eT0iMC4zIi8+Cjx0ZXh0IHg9IjcwIiB5PSIxODAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgZmlsbD0iI2I5YmJkNCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+6K+36L6T5YWl5Y2g5L2N5L2N5Y2g8L3RleHQ+Cjwvc3ZnPgo=';
    }
    
    // 图片错误处理函数
    function handleImageError(img) {
      try {
        console.log('图片错误处理:', { currentSrc: img.src });
        img.onerror = null;
        img.classList.remove('loading');
        img.classList.add('loaded');
        img.src = getDefaultSvgUrl();
        console.log('已设置默认图片');
      } catch (error) {
        console.error('图片错误处理失败:', error);
      }
    }
    
    // 图片加载处理函数 - 简化版本
    function handleImageLoad(img, targetUrl) {
      try {
        console.log('图片加载处理:', { targetUrl, currentSrc: img.src });
        
        // 清除onload事件，防止重复触发
        img.onload = null;
        
        // 如果目标URL有效且不是默认SVG，则加载目标图片
        if (targetUrl && targetUrl !== getDefaultSvgUrl() && targetUrl.trim() !== '') {
          console.log('开始加载目标图片:', targetUrl);
          
          // 设置新的图片源
          img.src = targetUrl;
          
          // 监听新图片加载完成
          img.addEventListener('load', function() {
            console.log('目标图片加载成功:', targetUrl);
            img.classList.remove('loading');
            img.classList.add('loaded');
          }, { once: true });
          
          // 监听新图片加载失败
          img.addEventListener('error', function() {
            console.log('目标图片加载失败:', targetUrl);
            handleImageError(img);
          }, { once: true });
        } else {
          console.log('目标URL无效或为空，保持默认图片');
          // 如果目标URL无效或就是默认SVG，直接设置为已加载状态
          img.classList.add('loaded');
        }
      } catch (error) {
        console.error('图片加载处理失败:', error);
        handleImageError(img);
      }
    }
    
    // 全局错误处理
    window.addEventListener('error', function(event) {
      console.error('全局JavaScript错误:', {
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        error: event.error
      });
      
      // 在错误发生时尝试恢复交互状态
      setTimeout(() => {
        // restorePageInteraction();
      }, 100);
    });
    
    // 未处理的Promise拒绝处理
    window.addEventListener('unhandledrejection', function(event) {
      console.error('未处理的Promise拒绝:', event.reason);
      
      // 在Promise拒绝时尝试恢复交互状态
      setTimeout(() => {
        // restorePageInteraction();
      }, 100);
    });
    
    // 页面初始化
    (function() {
      // 页面刷新时强制滚动到顶部
      if (window.history.scrollRestoration) {
        window.history.scrollRestoration = 'manual';
      }
      window.scrollTo(0, 0);
      
      // 页面刷新时重置滚动位置变量
      window._lastRecommendScrollY = undefined;
      console.log('页面刷新，重置滚动位置变量');
      
      // 确保主内容区域状态正确
      setTimeout(() => {
        // restorePageInteraction();
        // console.log('主内容区域交互状态已重置');
      }, 100);
    })();
    
    // 额外的页面初始化检查
    if (document.readyState === 'loading') {
      document.addEventListener('readystatechange', function() {
        if (document.readyState === 'interactive') {
          // 确保页面滚动到顶部
          window.scrollTo(0, 0);
        }
      });
    }
    
    // 全局状态
    let currentType = 'movie';
    let currentTag = '';
    let tags = [];
    let subjects = [];
    let pageStart = 0;
    const pageLimit = 20;
    let loading = false;
    let noMore = false;
    window._lastRecommendScrollY = undefined;
    
    // 搜索控制器 - 用于取消正在进行的搜索
    let searchController = null;
    let currentSearchId = 0;

    // DOM 元素
    const menuBtn = document.getElementById('menuBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarMask = document.getElementById('sidebarMask');
    const overlay = document.getElementById('overlay');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const searchClearBtn = document.getElementById('searchClearBtn');
    const movieTab = document.getElementById('movieTab');
    const tvTab = document.getElementById('tvTab');
    const tagsContainer = document.getElementById('tagsContainer');
    const videoGrid = document.getElementById('videoGrid');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const closeSidebarBtn = document.getElementById('closeSidebarBtn');

    // 初始化
    async function init() {
      console.log('初始化开始...');
      
      // 确保DOM元素存在
      if (!menuBtn || !sidebar || !sidebarMask || !overlay) {
        console.error('关键DOM元素未找到');
        return;
      }
      
      console.log('DOM元素检查通过');
      bindEvents();
      
      // 初始化搜索框清空按钮状态
      handleSearchInputChange();
      
      // 初始化关于按钮状态（只在豆瓣推荐页面显示）
      const aboutBtn = document.getElementById('aboutBtn');
      if (aboutBtn) {
        aboutBtn.style.display = 'flex';
        console.log('初始化：显示关于按钮（豆瓣推荐页面）');
      }
      
      // 先获取视频源列表
      await fetchVideoSources();
      
      // 延迟一点时间再获取数据，确保页面完全加载
      setTimeout(() => {
        fetchTagsAndSubjects();
      }, 100);
    }

    // 绑定事件
    function bindEvents() {
      console.log('绑定事件...');

      // 搜索功能
      if (searchBtn) {
      searchBtn.addEventListener('click', handleSearch);
      }
      if (searchClearBtn) {
        searchClearBtn.addEventListener('click', handleSearchClear);
      }
      if (searchInput) {
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleSearch();
        }
      });
        
        // 监听输入变化，控制清空按钮显示
        searchInput.addEventListener('input', handleSearchInputChange);
        
        // 防止iOS自动放大和恢复缩放
        searchInput.addEventListener('focus', handleSearchInputFocus);
        searchInput.addEventListener('blur', handleSearchInputBlur);
      }

      // 类型切换
      if (movieTab) {
      movieTab.addEventListener('click', () => switchType('movie'));
      }
      if (tvTab) {
      tvTab.addEventListener('click', () => switchType('tv'));
      }
      
      // 加载更多
      if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', loadMore);
      }
      
      // 滚动监听
      window.addEventListener('scroll', handleScroll);
      
      // 侧边栏相关事件
      console.log('绑定侧边栏事件...');
      console.log('menuBtn元素:', menuBtn);
      console.log('toggleSidebar函数:', toggleSidebar);
      if (menuBtn) {
        menuBtn.addEventListener('click', toggleSidebar);
      }
      if (sidebarMask) {
        sidebarMask.addEventListener('click', closeSidebar);
      }
      if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', closeSidebar);
      }
      console.log('侧边栏事件绑定完成');
      
      // 防止iOS双击缩放
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);
      
      // 防止iOS双指缩放
      document.addEventListener('gesturestart', function (event) {
        event.preventDefault();
      }, false);
      
      document.addEventListener('gesturechange', function (event) {
        event.preventDefault();
      }, false);
      
      document.addEventListener('gestureend', function (event) {
        event.preventDefault();
      }, false);
      
      // 监听visualViewport变化（如果支持）
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', function() {
          console.log('visualViewport变化:', window.visualViewport.scale);
          // 如果缩放比例不是1.0，尝试恢复
          if (window.visualViewport.scale !== 1.0) {
            setTimeout(() => {
              restorePageZoom();
            }, 100);
          }
        });
      }
    }

    // 处理搜索框焦点事件 - 防止iOS自动放大
    function handleSearchInputFocus() {
      console.log('搜索框获得焦点');
      
      // 检测是否为iOS设备
      const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
      if (isIOS) {
        console.log('iOS设备检测到，防止自动放大');
        
        // 延迟一点时间，确保输入框完全获得焦点
        setTimeout(() => {
          // 强制设置视口缩放为1.0
          const viewport = document.querySelector('meta[name=viewport]');
          if (viewport) {
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
          }
          
          // 滚动到搜索框位置，确保可见
          const searchInput = document.getElementById('searchInput');
          if (searchInput) {
            searchInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      }
    }

    // 处理搜索框失焦事件 - 恢复页面缩放
    function handleSearchInputBlur() {
      console.log('搜索框失去焦点');
      
      // 检测是否为iOS设备
      const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
      if (isIOS) {
        console.log('iOS设备检测到，恢复页面缩放');
        
        // 立即执行一次恢复
        restorePageZoom();
        
        // 延迟执行多次恢复，确保生效
        setTimeout(() => restorePageZoom(), 100);
        setTimeout(() => restorePageZoom(), 300);
        setTimeout(() => restorePageZoom(), 500);
        setTimeout(() => restorePageZoom(), 1000);
      }
    }
    
    // 处理搜索框输入变化 - 控制清空按钮显示
    function handleSearchInputChange() {
      const searchInput = document.getElementById('searchInput');
      const searchClearBtn = document.getElementById('searchClearBtn');
      
      if (searchInput && searchClearBtn) {
        const hasValue = searchInput.value.trim().length > 0;
        searchClearBtn.style.display = hasValue ? 'flex' : 'none';
      }
    }
    
    // 处理清空搜索按钮点击
    function handleSearchClear() {
      const searchInput = document.getElementById('searchInput');
      const searchClearBtn = document.getElementById('searchClearBtn');
      
      if (searchInput) {
        // 取消正在进行的搜索
        if (searchController) {
          console.log('清空搜索时取消正在进行的搜索');
          searchController.abort();
        }
        
        searchInput.value = '';
        searchInput.focus(); // 保持焦点在输入框
        searchClearBtn.style.display = 'none';
        
        // 显示清空提示
        showToast('搜索内容已清空', 'info', 1500);
        
        console.log('搜索内容已清空');
      }
    }
    
    // 恢复页面缩放的辅助函数
    function restorePageZoom() {
      console.log('执行页面缩放恢复...');
      
      // 方法1: 重新设置视口
      const viewport = document.querySelector('meta[name=viewport]');
      if (viewport) {
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
      }
      
      // 方法2: 强制重新计算布局
      document.body.style.transform = 'translateZ(0)';
      document.documentElement.style.transform = 'translateZ(0)';
      
      // 方法3: 触发重排
      document.body.offsetHeight;
      document.documentElement.offsetHeight;
      
      // 方法4: 滚动到顶部
      window.scrollTo(0, 0);
      
      // 方法5: 使用visualViewport API（如果支持）
      if (window.visualViewport) {
        console.log('使用visualViewport API恢复缩放');
        // 强制触发visualViewport变化
        window.visualViewport.scale = 1.0;
      }
      
      // 方法6: 延迟清除transform
      setTimeout(() => {
        document.body.style.transform = '';
        document.documentElement.style.transform = '';
      }, 50);
      
      // 方法7: 强制刷新视口
      setTimeout(() => {
        if (viewport) {
          viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
        }
      }, 100);
      
      // 方法8: 使用CSS zoom属性（兼容性方法）
      setTimeout(() => {
        document.body.style.zoom = '1';
        document.documentElement.style.zoom = '1';
        setTimeout(() => {
          document.body.style.zoom = '';
          document.documentElement.style.zoom = '';
        }, 10);
      }, 150);
    }

    // 切换侧边栏
    function toggleSidebar() {
      console.log('切换侧边栏函数被调用...');
      console.log('menuBtn元素:', menuBtn);
      console.log('sidebar元素:', sidebar);
      console.log('sidebarMask元素:', sidebarMask);
      console.log('切换前侧边栏状态:', sidebar.classList.contains('active'));
      sidebar.classList.toggle('active');
      sidebarMask.classList.toggle('active');
      menuBtn.classList.toggle('active');
      console.log('切换后侧边栏状态:', sidebar.classList.contains('active'));
      console.log('侧边栏样式:', sidebar.style.cssText);
      console.log('侧边栏类名:', sidebar.className);
    }

    // 关闭侧边栏
    function closeSidebar() {
      sidebar.classList.remove('active');
      sidebarMask.classList.remove('active');
      menuBtn.classList.remove('active');
      
      // iOS设备关闭侧边栏时检查页面缩放
      const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
      if (isIOS) {
        console.log('关闭侧边栏时检查页面缩放');
        setTimeout(() => restorePageZoom(), 100);
      }
    }

    // 切换内容类型
    function switchType(type) {
      if (currentType === type) return;
      
      currentType = type;
      currentTag = '';
      pageStart = 0;
      subjects = [];
      noMore = false;

      // 更新UI
      if (movieTab) {
      movieTab.classList.toggle('active', type === 'movie');
      }
      if (tvTab) {
      tvTab.classList.toggle('active', type === 'tv');
      }
      // 取消豆瓣最新推荐按钮高亮
      const doubanLatestTab = document.getElementById('doubanLatestTab');
      if (doubanLatestTab) {
      doubanLatestTab.classList.remove('active');
      }

      // 隐藏播放层（如果正在显示）
      const playerLayer = document.getElementById('playerLayerMobile');
      if (playerLayer && playerLayer.style.display !== 'none') {
        console.log('类型切换时隐藏播放层');
        hidePlayerLayer();
      }
      
      // 确保在推荐页面，显示关于按钮
      const aboutBtn = document.getElementById('aboutBtn');
      if (aboutBtn) {
        aboutBtn.style.display = 'flex';
        console.log('类型切换：显示关于按钮（豆瓣推荐页面）');
      }
      
      // iOS设备类型切换时检查页面缩放
      const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
      if (isIOS) {
        console.log('类型切换时检查页面缩放');
        setTimeout(() => restorePageZoom(), 100);
      }

      // 重新获取数据
      fetchTagsAndSubjects();
    }

    // 搜索处理
    function handleSearch() {
      // 清理之前的搜索状态
      cleanupSearch();
      
      const keyword = searchInput.value.trim();
      
      // 先隐藏播放层（如果正在显示）
      const playerLayer = document.getElementById('playerLayerMobile');
      if (playerLayer && playerLayer.style.display !== 'none') {
        console.log('搜索时隐藏播放层');
        hidePlayerLayer();
      }
      
      // iOS设备搜索时恢复页面缩放
      const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
      if (isIOS) {
        console.log('搜索时恢复页面缩放');
        restorePageZoom();
      }
      
      if (!keyword) {
        // 空搜索条件，获取所选视频源的最新视频
        console.log('空搜索条件，获取最新视频');
        mobilePerformSearch({
          keyword: '',
          type: '最新推荐',
          tag: '',
          year: '',
          rate: '',
          isLatest: true
        });
      } else {
        // 有搜索关键词，执行普通搜索
        console.log('搜索关键词:', keyword);
        mobilePerformSearch({
          keyword: keyword,
          type: '搜索结果',
          tag: '',
          year: '',
          rate: '',
          isLatest: false
        });
      }
      
      // 关闭侧边栏
      closeSidebar();
    }

    // 获取标签和推荐内容
    function fetchTagsAndSubjects() {
      console.log('获取标签和推荐内容...');
      // 显示加载状态
      if (tagsContainer) {
      tagsContainer.innerHTML = '<span class="loading">加载中...</span>';
      }
      if (videoGrid) {
      videoGrid.innerHTML = '<div class="loading-card"><div class="loading-spinner"></div><div class="loading-text">加载中...</div></div>';
      }
      
      // 调用程序本身的接口获取标签
      const tagsUrl = `/douban?action=tags&type=${currentType}`;
      console.log('请求标签URL:', tagsUrl);
      
      fetch(tagsUrl)
        .then(res => {
          console.log('标签请求响应状态:', res.status);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          return res.json();
        })
        .then(data => {
          console.log('标签数据:', data);
          tags = data.tags || [];
          // 优先选择"最新"标签，如果没有则使用第一个标签
          currentTag = tags.find(tag => tag === '最新') || tags[0] || '';
          renderTags();
          fetchSubjects(true);
        })
        .catch((error) => {
          console.error('标签加载失败:', error);
          if (tagsContainer) {
          tagsContainer.innerHTML = '<span class="loading" style="color:#f66;">标签加载失败: ' + error.message + '</span>';
          }
          // 使用默认标签
          tags = currentType === 'movie' 
            ? ['热门', '最新', '高分', '动作', '喜剧', '爱情', '科幻', '恐怖', '剧情', '动画']
            : ['热门', '最新', '高分', '都市', '古装', '悬疑', '喜剧', '爱情', '科幻', '战争'];
          // 优先选择"最新"标签，如果没有则使用第一个标签
          currentTag = tags.find(tag => tag === '最新') || tags[0];
          renderTags();
          fetchSubjects(true);
        });
    }

    // 渲染标签
    function renderTags() {
      console.log('渲染标签...');
      if (!tagsContainer) {
        console.error('tagsContainer元素不存在');
        return;
      }
      tagsContainer.innerHTML = '';
      tags.forEach(tag => {
        const btn = document.createElement('button');
        btn.className = 'tag-btn' + (tag === currentTag ? ' active' : '');
        btn.textContent = tag;
        btn.onclick = () => {
          if (currentTag !== tag) {
            currentTag = tag;
            pageStart = 0;
            subjects = [];
            noMore = false;
            renderTags();
          }
          // 自动收起侧边栏
          closeSidebar();
          // 隐藏播放层（如果正在显示）
          const playerLayer = document.getElementById('playerLayerMobile');
          if (playerLayer && playerLayer.style.display !== 'none') {
            console.log('标签切换时隐藏播放层');
            hidePlayerLayer();
          }
          // 切换到推荐区，隐藏搜索结果区
          document.getElementById('recommendSectionMobile').style.display = 'block';
          document.getElementById('searchResultsMobile').style.display = 'none';
          var recommendHeader = document.getElementById('recommendHeaderMobile');
          if (recommendHeader) recommendHeader.style.display = '';
          
          // 显示关于按钮（回到豆瓣推荐页面）
          const aboutBtn = document.getElementById('aboutBtn');
          if (aboutBtn) {
            aboutBtn.style.display = 'flex';
            console.log('标签切换：显示关于按钮（回到豆瓣推荐页面）');
          }
          
          // 滚动到页面顶部
          window.scrollTo({ top: 0, behavior: 'smooth' });
          
          // iOS设备标签切换时检查页面缩放
          const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
          if (isIOS) {
            console.log('标签切换时检查页面缩放');
            setTimeout(() => restorePageZoom(), 100);
          }
          
          // 加载对应类型和标签的推荐内容
          fetchSubjects(true);
        };
        tagsContainer.appendChild(btn);
      });
      updateCurrentCategory();
    }

    // 获取推荐内容
    function fetchSubjects(reset = false) {
      if (loading || noMore) return;
      if (!videoGrid) {
        console.error('videoGrid元素不存在');
        return;
      }
      loading = true;
      console.log(`正在加载推荐内容: 类型=${currentType}, 标签=${currentTag}, 页码=${pageStart}, 每页=${pageLimit}`);
      
      if (reset) {
        videoGrid.innerHTML = '<div class="loading-card"><div class="loading-spinner"></div><div class="loading-text">加载中...</div></div>';
      } else {
        // 加载更多提示
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingMore';
        loadingDiv.style = 'color:#b3b6d4;padding:24px 0;text-align:center;width:100%;grid-column:1/-1;';
        loadingDiv.textContent = '加载中...';
        videoGrid.appendChild(loadingDiv);
      }
      
      // 调用程序本身的接口获取推荐内容
      const subjectsUrl = `/douban?action=subjects&type=${currentType}&tag=${encodeURIComponent(currentTag)}&page_limit=${pageLimit}&page_start=${pageStart}`;
      console.log('请求推荐内容URL:', subjectsUrl);
      
      fetch(subjectsUrl)
        .then(res => {
          console.log('推荐内容请求响应状态:', res.status);
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
          }
          return res.json();
        })
        .then(data => {
          console.log('推荐内容数据:', data);
          const newSubjects = data.subjects || [];
          console.log(`推荐内容加载成功: 获取到${newSubjects.length}个内容`);
          
          if (reset) {
            subjects = newSubjects;
            renderVideos();
          } else {
            // 移除加载更多提示
            const loadingDiv = document.getElementById('loadingMore');
            if (loadingDiv) loadingDiv.remove();
            subjects = subjects.concat(newSubjects);
            appendVideos(newSubjects);
          }
          
          if (newSubjects.length < pageLimit) {
            noMore = true;
            if (loadMoreBtn) {
            loadMoreBtn.style.display = 'none';
            }
            if (subjects.length > 0 && videoGrid) {
              const endDiv = document.createElement('div');
              endDiv.style = 'color:#b3b6d4;padding:24px 0;text-align:center;width:100%;grid-column:1/-1;';
              endDiv.textContent = '没有更多内容了';
              videoGrid.appendChild(endDiv);
            }
          } else {
            pageStart += pageLimit;
          }
          loading = false;
        })
        .catch((error) => {
          console.error('推荐内容加载失败:', error);
          if (reset && videoGrid) {
            videoGrid.innerHTML = '<div class="no-results"><div class="no-results-icon">❌</div>推荐加载失败: ' + error.message + '</div>';
          } else {
            const loadingDiv = document.getElementById('loadingMore');
            if (loadingDiv) loadingDiv.textContent = '加载失败: ' + error.message;
          }
          loading = false;
        });
    }



    // 渲染视频列表
    function renderVideos() {
      console.log('渲染视频列表...');
      if (!videoGrid) {
        console.error('videoGrid元素不存在');
        return;
      }
      // 渲染前清空所有内容（包括加载卡片）
      videoGrid.innerHTML = '';
      if (!subjects.length) {
        videoGrid.innerHTML = '<div class="no-results"><div class="no-results-icon">📺</div>暂无推荐内容</div>';
        return;
      }
      
      // 应用过滤逻辑
      const filteredSubjects = filterVideoContent(subjects);
      console.log('过滤后的推荐内容数量:', filteredSubjects.length, '个');
      
      if (!filteredSubjects.length) {
        videoGrid.innerHTML = '<div class="no-results"><div class="no-results-icon">📺</div>暂无推荐内容</div>';
        return;
      }
      
      appendVideos(filteredSubjects);
    }

    // 添加视频卡片
    function appendVideos(videos) {
      console.log('添加视频卡片:', videos.length, '个');
      
      if (!videoGrid) {
        console.error('videoGrid元素不存在');
        return;
      }
      // 渲染前清空所有内容（包括加载卡片）
      if (videoGrid.innerHTML.includes('loading-card')) videoGrid.innerHTML = '';
      videos.forEach(video => {
        const card = document.createElement('div');
        card.className = 'video-card';
        // 处理视频信息，兼容真实数据结构
        const title = video.title || video.name || '未知标题';
        // 获取原始图片URL
        const originalCover = video.cover || video.pic || '';
        const year = video.year || video.pubdate || '';
        const rate = video.rate || video.rating || '';
        const type = currentType === 'movie' ? '电影' : '电视剧';
        const tag = video.tag || video.type_name || '';
        
        // 确定最终图片URL
        const finalCoverUrl = originalCover && originalCover.trim() && !originalCover.includes('placeholder.com') 
          ? originalCover 
          : getDefaultSvgUrl();
        
        card.innerHTML = `
          <img class="video-cover" src="${finalCoverUrl}" alt="${title}" loading="lazy" referrerpolicy="no-referrer" onerror="handleImageError(this);">
          <div class="video-info">
            <div class="video-title">${title}</div>
            <div class="video-meta">
              <span class="meta-badge type">${type}</span>
              ${tag ? `<span class="meta-badge tag">${tag}</span>` : ''}
              ${rate ? `<span class="meta-badge rate">★ ${rate}</span>` : ''}
              ${year ? `<span class="meta-badge year">${year}</span>` : ''}
              <span class="meta-badge tag">${currentTag}</span>
            </div>
          </div>
        `;
        // 点击事件 - 搜索相关视频，传递所有关键信息
        card.addEventListener('click', () => {
          // 如果当前在播放层，先隐藏播放层
          const playerLayer = document.getElementById('playerLayerMobile');
          if (playerLayer && playerLayer.style.display !== 'none') {
            console.log('推荐卡片点击时隐藏播放层');
            hidePlayerLayer();
          }
          
          mobilePerformSearch({
            keyword: title,
            type: type,
            tag: tag,
            year: year,
            rate: rate
          });
        });
        videoGrid.appendChild(card);
      });
      updateCurrentCategory();
    }

    // 加载更多
    function loadMore() {
      if (!loading && !noMore) {
        fetchSubjects(false);
      }
    }

    // 滚动加载功能
    function handleScroll() {
      const scrollY = window.scrollY || window.pageYOffset;
      const viewport = window.innerHeight;
      const fullHeight = document.body.scrollHeight;
      
      // 检查是否接近页面底部（距离底部200px内）
      if (scrollY + viewport + 200 >= fullHeight) {
        // 在推荐页面，加载更多推荐
        if (!loading && !noMore) {
          fetchSubjects(false);
        }
      }
      
      // iOS设备滚动时定期检查页面缩放（节流处理）
      const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
      if (isIOS && !window.scrollZoomCheckTimer) {
        window.scrollZoomCheckTimer = setTimeout(() => {
          if (window.visualViewport && window.visualViewport.scale !== 1.0) {
            console.log('滚动时检测到异常缩放，正在恢复...');
            restorePageZoom();
          }
          window.scrollZoomCheckTimer = null;
        }, 500); // 500ms节流
      }
    }


    
    // 页面加载完成后启动
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM加载完成，启动应用...');
      // 确保页面滚动到顶部
      window.scrollTo(0, 0);
      // 启动应用
      init().catch(error => {
        console.error('初始化失败:', error);
      });
    });

    // 备用启动方式
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        window.scrollTo(0, 0);
        init().catch(error => {
          console.error('初始化失败:', error);
        });
      });
    } else {
      window.scrollTo(0, 0);
      init().catch(error => {
        console.error('初始化失败:', error);
      });
    }
    
    // 页面完全加载后
    window.addEventListener('load', function() {
      console.log('页面完全加载完成');
      // 最终确保页面滚动到顶部
      window.scrollTo(0, 0);
      
      // 检查HLS和AirPlay支持
      setTimeout(() => {
        checkMobileHlsSupport();
        checkMobileSafariAirPlay();
        setupNetworkMonitoring(); // 启动网络监控
        initPlayerCache(); // 初始化播放器缓存
        
        // 确保iOS视口设置正确
        const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
        if (isIOS) {
          console.log('iOS设备检测到，确保视口设置正确');
          const viewport = document.querySelector('meta[name=viewport]');
          if (viewport) {
            viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
          }
          
          // 初始化时执行一次缩放恢复
          setTimeout(() => {
            restorePageZoom();
          }, 1000);
          
          // 定期检查并恢复缩放
          setInterval(() => {
            if (window.visualViewport && window.visualViewport.scale !== 1.0) {
              console.log('检测到异常缩放，正在恢复...');
              restorePageZoom();
            }
          }, 2000);
        }
        
        console.log('页面完全加载后，交互状态已确保正确');
      }, 500);
    });
    
    // 页面可见性变化时恢复交互状态
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        console.log('页面重新可见，恢复交互状态');
        // restorePageInteraction();
      }
    });
    
    // 窗口焦点变化时恢复交互状态
    window.addEventListener('focus', function() {
      console.log('窗口获得焦点，恢复交互状态');
      // restorePageInteraction();
      
      // PC端额外处理
      const isPC = !(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
      if (isPC && window.fixPCInteraction) {
        window.fixPCInteraction();
      }
    });
    
              // 定期检查页面交互状态
    setInterval(() => {
      const playerLayer = document.getElementById('playerLayerMobile');
      if (playerLayer && playerLayer.style.display === 'none') {
        // 如果播放器层隐藏了，检查页面交互状态
        const header = document.querySelector('.header');
        const mainContent = document.querySelector('.main-content');
        
        if (header && header.style.pointerEvents === 'none') {
          console.log('检测到页面交互状态异常，正在恢复...');
          // restorePageInteraction();
        }
        
        // 检查是否有覆盖层
        const allElements = document.querySelectorAll('*');
        let hasOverlay = false;
        allElements.forEach(el => {
          const style = window.getComputedStyle(el);
          const zIndex = parseInt(style.zIndex);
          if (zIndex > 1000 && 
              el !== document.body && 
              el !== document.documentElement &&
              !el.classList.contains('header') &&
              !el.classList.contains('sidebar')) {
            hasOverlay = true;
          }
        });
        
        if (hasOverlay) {
          console.log('检测到覆盖层，正在移除...');
          if (window.findAndRemoveOverlay) {
            window.findAndRemoveOverlay();
          }
        }
        
        // PC端特殊检查
        const isPC = !(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent));
        if (isPC) {
          // 检查PC端关键元素是否可以点击
          const menuBtn = document.getElementById('menuBtn');
          const searchBtn = document.getElementById('searchBtn');
          
          if (menuBtn && menuBtn.style.pointerEvents === 'none') {
            console.log('PC端：检测到菜单按钮无法点击，正在修复...');
            if (window.fixPCInteraction) {
              window.fixPCInteraction();
            }
          }
        }
      }
    }, 3000); // 每3秒检查一次

    // 在JS中，添加一个函数用于更新当前分类显示，并在切换类型、切换标签、初始化时调用

    function updateCurrentCategory() {
      const typeText = currentType === 'movie' ? '电影' : '电视剧';
      const tagText = currentTag ? ` / ${currentTag}` : '';
      document.getElementById('currentCategory').textContent = `${typeText}${tagText}`;
    }

    // 在renderTags、switchType、renderVideos等相关函数最后调用 updateCurrentCategory();
    // 例如：
    // renderTags() 结尾加 updateCurrentCategory();
    // switchType() 结尾加 updateCurrentCategory();
    // renderVideos() 结尾加 updateCurrentCategory();

    // 视频源配置（从API动态获取）
    let VIDEO_SOURCES = [];
    let selectedSources = JSON.parse(localStorage.getItem('vastvideo_sources_mobile') || '["bfzy","dyttzy"]');

    // 从API获取视频源列表
    async function fetchVideoSources() {
      try {
        console.log('正在从API获取视频源列表...');
        const response = await fetch('/api/sources');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        if (data.success && data.data) {
          VIDEO_SOURCES = data.data;
          console.log('视频源列表获取成功:', VIDEO_SOURCES.length, '个源');
          
          // 验证已选择的源是否仍然存在
          const validSources = selectedSources.filter(code => 
            VIDEO_SOURCES.some(src => src.code === code)
          );
          if (validSources.length !== selectedSources.length) {
            console.log('部分已选择的源不存在，更新选择列表');
            selectedSources = validSources;
            localStorage.setItem('vastvideo_sources_mobile', JSON.stringify(validSources));
          }
          
          // 如果没有任何选择的源，使用后端配置的默认源
          if (selectedSources.length === 0 && VIDEO_SOURCES.length > 0) {
            const defaultSources = VIDEO_SOURCES.filter(src => src.is_default).map(src => src.code);
            if (defaultSources.length > 0) {
              selectedSources = defaultSources;
              console.log('使用后端配置的默认源:', defaultSources);
            } else {
              // 如果没有配置默认源，使用前两个源作为备用
              selectedSources = VIDEO_SOURCES.slice(0, 2).map(src => src.code);
              console.log('使用备用默认源:', selectedSources);
            }
            localStorage.setItem('vastvideo_sources_mobile', JSON.stringify(selectedSources));
          }
        } else {
          throw new Error('API返回数据格式错误');
        }
      } catch (error) {
        console.error('获取视频源列表失败:', error);
        // 使用默认源列表作为备用
        VIDEO_SOURCES = [
          { code: 'bfzy', name: '暴风资源', url: 'https://bfzyapi.com/api.php/provide/vod', is_default: true },
          { code: 'dyttzy', name: '电影天堂资源', url: 'http://caiji.dyttzyapi.com/api.php/provide/vod', is_default: true }
        ];
      }
    }

    // 渲染侧边栏内视频源
    function renderSourcesListSidebar() {
      const list = document.getElementById('sourcesListSidebar');
      list.innerHTML = '';
      VIDEO_SOURCES.forEach(src => {
        const checked = selectedSources.includes(src.code) ? 'checked' : '';
        const label = document.createElement('label');
        label.style = 'display:flex;align-items:center;gap:8px;font-size:14px;color:#b3b6d4;padding:10px 8px;cursor:pointer;background:rgba(24,25,43,0.7);border-radius:8px;border:1px solid rgba(108,99,255,0.1);user-select:none;pointer-events:auto;margin-bottom:6px;transition:all 0.2s ease;';
        label.innerHTML = `<input type="checkbox" value="${src.code}" style="accent-color:#6c63ff;width:16px;height:16px;pointer-events:auto;" ${checked}><span>${src.name}</span>`;
        
        // 为每个标签添加事件阻止冒泡
        label.addEventListener('click', function(e) {
          e.stopPropagation();
        });
        
        // 为复选框添加事件阻止冒泡
        const checkbox = label.querySelector('input[type="checkbox"]');
        if (checkbox) {
          checkbox.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }
        
        // 添加悬停效果
        label.addEventListener('mouseenter', function() {
          this.style.background = 'rgba(108,99,255,0.2)';
          this.style.borderColor = 'rgba(108,99,255,0.4)';
        });
        
        label.addEventListener('mouseleave', function() {
          this.style.background = 'rgba(24,25,43,0.7)';
          this.style.borderColor = 'rgba(108,99,255,0.1)';
        });
        
        list.appendChild(label);
      });
      
      console.log('侧边栏视频源列表已渲染，共', VIDEO_SOURCES.length, '个源');
    }

    // 视频源选择侧边栏事件处理
    document.addEventListener('DOMContentLoaded', function() {
      // 切换视频源选择区域
      document.getElementById('toggleSourceSelectionBtn').onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const selectionArea = document.getElementById('sourceSelectionArea');
        const isVisible = selectionArea.style.display !== 'none';
        
        if (!isVisible) {
          // 显示视频源选择区域
          renderSourcesListSidebar();
          selectionArea.style.display = 'block';
          console.log('视频源选择区域已显示');
        } else {
          // 隐藏视频源选择区域
          selectionArea.style.display = 'none';
          console.log('视频源选择区域已隐藏');
        }
      };
      
      // 保存视频源选择
      document.getElementById('saveSourcesBtnSidebar').onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const checked = Array.from(document.querySelectorAll('#sourcesListSidebar input[type=checkbox]:checked')).map(i=>i.value);
        if(checked.length === 0){
          showToast('请至少选择一个视频源', 'warning', 2000);
          return;
        }
        
        selectedSources = checked;
        localStorage.setItem('vastvideo_sources_mobile', JSON.stringify(checked));
        
        // 隐藏视频源选择区域
        document.getElementById('sourceSelectionArea').style.display = 'none';
        
        showToast('视频源选择已保存', 'success', 2000);
        console.log('✅ 视频源选择已保存:', checked);
        console.log('✅ 当前selectedSources变量:', selectedSources);
      };
      
      // 全选按钮
      document.getElementById('selectAllBtnSidebar').onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        document.querySelectorAll('#sourcesListSidebar input[type=checkbox]').forEach(i => i.checked = true);
        console.log('已全选所有视频源');
      };
      
      // 反选按钮
      document.getElementById('invertSelectBtnSidebar').onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        document.querySelectorAll('#sourcesListSidebar input[type=checkbox]').forEach(i => i.checked = !i.checked);
        console.log('已反选视频源');
      };
      
      // 关闭视频源选择区域
      document.getElementById('closeSourceSelectionBtn').onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        document.getElementById('sourceSelectionArea').style.display = 'none';
        console.log('视频源选择区域已关闭');
      };
    });

    // 过滤设置事件处理
    document.addEventListener('DOMContentLoaded', function() {
      // 初始化过滤设置状态
      const filterEnabled = isFilterEnabled();
      console.log('🔍 页面加载时过滤设置状态:', filterEnabled ? '启用过滤' : '不过滤');
      
      // 过滤设置按钮点击事件
      document.getElementById('filterSettingsBtn').onclick = function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const filterArea = document.getElementById('filterSettingsArea');
        const isVisible = filterArea.style.display !== 'none';
        
        if (!isVisible) {
          // 显示过滤设置区域
          showFilterSettingsArea();
        } else {
          // 隐藏过滤设置区域
          hideFilterSettingsArea();
        }
      };

      // 提交密码按钮
      document.getElementById('submitPassword').onclick = function() {
        const password = document.getElementById('adminPassword').value;
        const storedPassword = localStorage.getItem('vastvideo_admin_password');
        
        // 检查本地存储的密码，如果为空或null则使用默认密码
        let correctPassword = (storedPassword && storedPassword.trim() !== '') ? storedPassword : '8228';
        
        console.log('🔐 密码验证:', { input: password, stored: storedPassword, correct: correctPassword });
        
        if (password === correctPassword) {
          showFilterSettingsSection();
        } else {
          showToast('密码错误', 'error', 2000);
        }
      };

      // 取消密码按钮
      document.getElementById('cancelPassword').onclick = function() {
        hideFilterSettingsArea();
      };

      // 修改密码按钮
      document.getElementById('changePasswordBtn').onclick = function() {
        const changeSection = document.getElementById('changePasswordSection');
        changeSection.style.display = changeSection.style.display === 'none' ? 'block' : 'none';
      };

      // 保存过滤设置
      document.getElementById('saveFilterSettings').onclick = function() {
        const adultContentEnabled = document.getElementById('adultContentToggle').checked;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // 保存过滤设置到本地存储
        localStorage.setItem('vastvideo_adult_filter', JSON.stringify(adultContentEnabled));
        
        // 如果输入了新密码，保存新密码
        if (newPassword && newPassword === confirmPassword) {
          localStorage.setItem('vastvideo_admin_password', newPassword);
          showToast('密码已更新', 'success', 2000);
          document.getElementById('changePasswordSection').style.display = 'none';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
        } else if (newPassword && newPassword !== confirmPassword) {
          showToast('两次输入的密码不一致', 'error', 2000);
          return;
        }
        
        showToast('过滤设置已保存', 'success', 2000);
        hideFilterSettingsArea();
      };

      // 关闭过滤设置
      document.getElementById('closeFilterSettings').onclick = function() {
        hideFilterSettingsArea();
      };

      // 密码输入框回车事件
      document.getElementById('adminPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('submitPassword').click();
        }
      });

      // 新密码输入框回车事件
      document.getElementById('newPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('saveFilterSettings').click();
        }
      });

      // 确认密码输入框回车事件
      document.getElementById('confirmPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('saveFilterSettings').click();
        }
      });

      // 过滤开关点击事件
      document.getElementById('adultContentToggle').addEventListener('change', function() {
        console.log('🔍 过滤开关状态改变:', this.checked);
        // 立即保存到本地存储
        localStorage.setItem('vastvideo_adult_filter', JSON.stringify(this.checked));
        console.log('🔍 过滤设置已保存到本地存储:', this.checked);
      });
    });

    // 显示过滤设置区域
    function showFilterSettingsArea() {
      const filterArea = document.getElementById('filterSettingsArea');
      const passwordSection = document.getElementById('passwordSection');
      const filterSection = document.getElementById('filterSettingsSection');
      
      // 重置界面状态
      passwordSection.style.display = 'block';
      filterSection.style.display = 'none';
      document.getElementById('adminPassword').value = '';
      document.getElementById('changePasswordSection').style.display = 'none';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      
      // 显示过滤设置区域
      filterArea.style.display = 'block';
    }

    // 隐藏过滤设置区域
    function hideFilterSettingsArea() {
      const filterArea = document.getElementById('filterSettingsArea');
      filterArea.style.display = 'none';
    }

    // 显示过滤设置界面
    function showFilterSettingsSection() {
      const passwordSection = document.getElementById('passwordSection');
      const filterSection = document.getElementById('filterSettingsSection');
      
      // 获取当前过滤设置并设置开关状态
      const filterEnabled = isFilterEnabled();
      document.getElementById('adultContentToggle').checked = filterEnabled;
      
      // 切换界面
      passwordSection.style.display = 'none';
      filterSection.style.display = 'block';
    }

    // 检查是否启用过滤（true=启用过滤，false=不过滤）
    function isFilterEnabled() {
      const stored = localStorage.getItem('vastvideo_adult_filter');
      // 如果没有设置过，使用默认状态（true=启用过滤）
      if (stored === null) {
        console.log('🔍 过滤设置未初始化，使用默认状态: 启用过滤');
        return true;
      }
      const enabled = JSON.parse(stored);
      console.log('🔍 过滤设置状态:', enabled ? '启用过滤' : '不过滤');
      return enabled;
    }

    // 过滤视频内容
    function filterVideoContent(videos) {
      const filterEnabled = isFilterEnabled();
      console.log('🔍 执行过滤检查 - 设置状态:', filterEnabled ? '启用过滤' : '不过滤');
      
      if (filterEnabled) {
        const originalCount = videos.length;
        const filteredVideos = videos.filter(video => {
          // 检查不同的字段名
          const typeName = video.type_name || video.type || '';
          // 过滤伦理片和理论片
          const shouldFilter = typeName === '伦理片' || typeName === '理论片';
          if (shouldFilter) {
            console.log('🚫 过滤视频:', video.vod_name || video.title, '类型:', typeName);
          }
          return !shouldFilter;
        });
        console.log(`🔍 过滤结果: ${originalCount} -> ${filteredVideos.length} 个视频`);
        return filteredVideos;
      }
      console.log('🔍 不过滤，显示所有视频');
      return videos;
    }

    // 移动端多源搜索
    function mobilePerformSearch(info) {
      // 取消之前的搜索
      if (searchController) {
        console.log('取消之前的搜索请求');
        searchController.abort();
      }
      
      // 创建新的搜索控制器
      searchController = new AbortController();
      currentSearchId++;
      const thisSearchId = currentSearchId;
      
      console.log(`开始新的搜索 (ID: ${thisSearchId}):`, info);
      
      // 兼容旧调用
      let keyword, type, tag, year, rate, isLatest;
      if (typeof info === 'string') {
        keyword = info;
        type = '搜索结果';
        tag = '';
        year = '';
        rate = '';
        isLatest = false;
      } else {
        keyword = info.keyword || '';
        type = info.type || '搜索结果';
        tag = info.tag || '';
        year = info.year || '';
        rate = info.rate || '';
        isLatest = info.isLatest || false;
      }
      
      // iOS设备搜索时检查页面缩放
      const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
      if (isIOS) {
        console.log('执行搜索时检查页面缩放');
        setTimeout(() => restorePageZoom(), 100);
      }
      
      // 保存当前推荐页面的滚动位置（在切换UI之前）
      window._lastRecommendScrollY = window.scrollY || window.pageYOffset;
      console.log('保存推荐页面滚动位置:', window._lastRecommendScrollY);
      
      // 切换UI
      var searchResults = document.getElementById('searchResultsMobile');
      var recommendSection = document.getElementById('recommendSectionMobile');
      // 动画滑入搜索区
      recommendSection.style.display = 'none';
      searchResults.style.display = 'block';
      searchResults.classList.remove('slide-out');
      searchResults.classList.add('slide-in');
      // 显示返回按钮
      showGlobalBackBtn('search');
      // 搜索时自动滚动到顶部
      window.scrollTo({ top: 0, behavior: 'auto' });
      // 隐藏推荐标题栏
      var recommendHeader = document.getElementById('recommendHeaderMobile');
      if (recommendHeader) recommendHeader.style.display = 'none';
      
      // 根据搜索类型设置标题栏
      let headerTitle = '';
      if (isLatest) {
        headerTitle = `<span style="font-size:18px;font-weight:600;">源的最新推荐</span>`;
      } else if (keyword) {
        headerTitle = `
          <span class="meta-badge type">${type}</span>
          ${tag ? `<span class="meta-badge tag">${tag}</span>` : ''}
          ${rate ? `<span class="meta-badge rate">★ ${rate}</span>` : ''}
          <span style="font-size:18px;font-weight:600;margin-left:8px;">${keyword}</span>
        `;
      } else {
        headerTitle = `<span style="font-size:18px;font-weight:600;">搜索结果</span>`;
      }
      
      document.getElementById('searchHeaderMobile').innerHTML = headerTitle;
      const searchGrid = document.getElementById('searchGridMobile');
      // 设置加载状态 - 使用视频卡片样式的加载占位
      searchGrid.innerHTML = '<div class="loading-card"><div class="loading-spinner"></div><div class="loading-text">搜索中...</div></div>';
      console.log('设置搜索加载卡片');
      
      // 获取已选源
      let sources = selectedSources && selectedSources.length ? selectedSources : ["bfzy","dyttzy"];
      console.log('🔍 搜索使用的视频源:', sources);
      console.log('🔍 当前选择的视频源:', selectedSources);
      let allVideos = [];
      if (!sources.length) { 
        searchGrid.innerHTML = '<div class="no-results"><div class="no-results-icon">⚠️</div><div style="margin-bottom: 8px; font-weight: 600;">未选择视频源</div><div style="font-size: 14px; color: #888;">请在侧边栏中选择视频源</div></div>'; 
        return; 
      }
      
      // 备用代理源列表
      const proxySources = [
        '/proxy?url=',
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url=',
        'https://thingproxy.freeboard.io/fetch/'
      ];
      
      // 初始化搜索结果展示
      searchGrid.innerHTML = '';
      let hasResults = false;
      let completedSources = 0;
      const totalSources = sources.length;
      let currentPage = 1; // 当前页码
      let isLoadingMore = false; // 是否正在加载更多
      let hasMoreData = true; // 是否还有更多数据
      
      // 检查是否所有源都完成
      function checkAllSourcesCompleted() {
        completedSources++;
        console.log(`源完成进度: ${completedSources}/${totalSources}`);
        
        // 如果所有源都完成了且没有结果
        if (completedSources === totalSources && !hasResults) {
          console.log('所有源都完成，但没有找到结果');
          
          // 检查是否使用的是默认选择的源（不是全部源）
          const isUsingDefaultSources = sources.length < VIDEO_SOURCES.length;
          
          if (isUsingDefaultSources) {
            // 使用默认源没有结果，提示并切换到全部源
            console.log('默认选择的源没有结果，切换到全部源搜索');
            showMobileToast('默认源无结果，正在使用全部源搜索...', 'info', 3000);
            
            // 切换到全部源重新搜索
            setTimeout(() => {
              const allSourceCodes = VIDEO_SOURCES.map(s => s.code);
              searchWithAllSources(allSourceCodes);
            }, 1000);
          } else {
            // 已经使用了全部源，显示无结果提示
          const header = document.getElementById('searchHeaderMobile');
          if (isLatest) {
            header.innerHTML = `<span style='font-size:18px;font-weight:600;'>暂无最新视频</span>`;
            searchGrid.innerHTML = `<div class="no-results"><div class="no-results-icon">📺</div><div style="margin-bottom: 8px; font-weight: 600;">暂无最新视频</div><div style="font-size: 14px; color: #888;">请稍后再试或更换视频源</div></div>`;
          } else {
            header.innerHTML = `<span style='font-size:18px;font-weight:600;'>未找到相关视频</span>`;
            searchGrid.innerHTML = `<div class="no-results"><div class="no-results-icon">🔍</div><div style="margin-bottom: 8px; font-weight: 600;">未找到相关视频</div><div style="font-size: 14px; color: #888;">请尝试更换关键词或视频源</div></div>`;
            }
          }
        }
      }
      
      // 使用全部源搜索的函数
      function searchWithAllSources(allSourceCodes) {
        console.log('开始使用全部源搜索:', allSourceCodes);
        
        // 更新搜索状态
        const header = document.getElementById('searchHeaderMobile');
        if (isLatest) {
          header.innerHTML = `<span style='font-size:18px;font-weight:600;'>使用全部源搜索最新视频...</span>`;
        } else {
          header.innerHTML = `<span style='font-size:18px;font-weight:600;'>使用全部源搜索: ${keyword}</span>`;
        }
        
        // 重新设置加载状态
        searchGrid.innerHTML = '<div class="loading-card"><div class="loading-spinner"></div><div class="loading-text">使用全部源搜索中...</div></div>';
        
        // 重置搜索状态
        hasResults = false;
        completedSources = 0;
        const totalAllSources = allSourceCodes.length;
        
        // 检查全部源是否完成
        function checkAllSourcesCompleted() {
          completedSources++;
          console.log(`全部源完成进度: ${completedSources}/${totalAllSources}`);
          
          if (completedSources === totalAllSources && !hasResults) {
            console.log('全部源都完成，但仍然没有找到结果');
            const header = document.getElementById('searchHeaderMobile');
            if (isLatest) {
              header.innerHTML = `<span style='font-size:18px;font-weight:600;'>暂无最新视频</span>`;
              searchGrid.innerHTML = `<div class="no-results"><div class="no-results-icon">📺</div><div style="margin-bottom: 8px; font-weight: 600;">暂无最新视频</div><div style="font-size: 14px; color: #888;">所有源都没有找到最新视频</div></div>`;
            } else {
              header.innerHTML = `<span style='font-size:18px;font-weight:600;'>未找到相关视频</span>`;
              searchGrid.innerHTML = `<div class="no-results"><div class="no-results-icon">🔍</div><div style="margin-bottom: 8px; font-weight: 600;">未找到相关视频</div><div style="font-size: 14px; color: #888;">所有源都没有找到相关视频</div></div>`;
            }
          }
        }
        
        // 使用全部源搜索
        allSourceCodes.forEach((code, index) => {
          const src = VIDEO_SOURCES.find(s => s.code === code);
          if (!src) {
            checkAllSourcesCompleted();
            return;
          }
          
                  searchSourceAsync(src, keyword, proxySources, allVideos, isLatest, currentPage, (videos) => {
          // 检查搜索是否已被取消
          if (thisSearchId !== currentSearchId) {
            console.log(`搜索 ${thisSearchId} 已被取消，跳过结果处理`);
            return;
          }
          
          if (videos && videos.length > 0) {
            console.log(`全部源搜索 - 源 ${src.name} 完成，获取到 ${videos.length} 个视频`);
            renderSourceResults(videos, src.name, index === 0 && !hasResults);
            hasResults = true;
          } else {
            console.log(`全部源搜索 - 源 ${src.name} 完成，无结果`);
          }
          checkAllSourcesCompleted();
        }, thisSearchId);
        });
      }
      
      // 异步搜索每个源
      sources.forEach((code, index) => {
        const src = VIDEO_SOURCES.find(s => s.code === code);
        if (!src) {
          checkAllSourcesCompleted();
          return;
        }
        
        // 异步搜索源
        searchSourceAsync(src, keyword, proxySources, allVideos, isLatest, currentPage, (videos) => {
          // 检查搜索是否已被取消
          if (thisSearchId !== currentSearchId) {
            console.log(`搜索 ${thisSearchId} 已被取消，跳过结果处理`);
            return;
          }
          
          if (videos && videos.length > 0) {
            console.log(`源 ${src.name} 完成，获取到 ${videos.length} 个视频，立即展示`);
            // 立即渲染这个源的结果（追加模式）
            renderSourceResults(videos, src.name, index === 0 && !hasResults);
            hasResults = true;
          } else {
            console.log(`源 ${src.name} 完成，无结果`);
          }
          checkAllSourcesCompleted();
        }, thisSearchId);
      });
      
      // 添加滚动监听，支持无限加载
      function handleSearchScroll() {
        const scrollY = window.scrollY || window.pageYOffset;
        const viewport = window.innerHeight;
        const fullHeight = document.body.scrollHeight;
        
        // 检查是否接近页面底部（距离底部200px内）
        if (scrollY + viewport + 200 >= fullHeight) {
          // 在搜索页面，加载更多搜索结果
          if (!isLoadingMore && hasMoreData && hasResults) {
            loadMoreSearchResults();
          }
        }
      }
      
      // 加载更多搜索结果
      function loadMoreSearchResults() {
        if (isLoadingMore || !hasMoreData) return;
        
        isLoadingMore = true;
        currentPage++;
        console.log(`加载更多搜索结果，页码: ${currentPage}`);
        
        // 显示加载更多提示
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'searchLoadingMore';
        loadingDiv.style = 'color:#b3b6d4;padding:24px 0;text-align:center;width:100%;grid-column:1/-1;';
        loadingDiv.innerHTML = '<div class="loading-spinner"></div><div style="margin-top:8px;">加载更多...</div>';
        searchGrid.appendChild(loadingDiv);
        
        // 重新搜索所有源，获取下一页数据
        let pageCompletedSources = 0;
        let hasNewData = false;
        
        sources.forEach(code => {
          const src = VIDEO_SOURCES.find(s => s.code === code);
          if (!src) {
            pageCompletedSources++;
            return;
          }
          
          searchSourceAsync(src, keyword, proxySources, allVideos, isLatest, currentPage, (videos) => {
            // 检查搜索是否已被取消
            if (thisSearchId !== currentSearchId) {
              console.log(`搜索 ${thisSearchId} 已被取消，跳过加载更多结果处理`);
              return;
            }
            
            pageCompletedSources++;
            
            // 移除加载提示
            const loadingDiv = document.getElementById('searchLoadingMore');
            if (loadingDiv) loadingDiv.remove();
            
            if (videos && videos.length > 0) {
              console.log(`源 ${src.name} 第${currentPage}页完成，获取到 ${videos.length} 个视频`);
              // 追加渲染这个源的结果
              renderSourceResults(videos, src.name, false);
              hasNewData = true;
            } else {
              console.log(`源 ${src.name} 第${currentPage}页完成，无结果`);
            }
            
            // 检查是否所有源都完成
            if (pageCompletedSources === totalSources) {
              isLoadingMore = false;
              
              // 如果所有源都没有新数据，标记没有更多数据
              if (!hasNewData) {
                hasMoreData = false;
                // 添加没有更多数据的提示
                const endDiv = document.createElement('div');
                endDiv.style = 'color:#b3b6d4;padding:24px 0;text-align:center;width:100%;grid-column:1/-1;';
                endDiv.textContent = '没有更多内容了';
                searchGrid.appendChild(endDiv);
              }
            }
          }, thisSearchId);
        });
      }
      
      // 添加滚动监听器并保存到全局变量
      window.handleSearchScroll = handleSearchScroll;
      window.addEventListener('scroll', window.handleSearchScroll);
      
      // 页面卸载时取消所有搜索
      window.addEventListener('beforeunload', () => {
        if (searchController) {
          searchController.abort();
        }
      });
    }
    
    // 清理搜索状态
    function cleanupSearch() {
      if (searchController) {
        console.log('清理搜索状态，取消所有搜索请求');
        searchController.abort();
        searchController = null;
      }
      currentSearchId++;
    }
    
    // 异步搜索单个源（带重试机制）
    async function searchSourceAsync(src, keyword, proxySources, allVideos, isLatest, page, onResult, searchId = null) {
      let apiUrl = '';
      if (src.code === 'dbzy') {
        // 豆瓣搜索接口
        if (isLatest) {
          // 获取豆瓣最新推荐 - 连续获取两页数据
          if (page === 1) {
            // 第一页时，连续获取两页数据
            await searchDoubanLatestTwoPages(src, onResult, searchId);
            return;
          } else {
            // 后续页面，一次获取一页
            // 由于第一页已经获取了两页数据，所以后续页面的页码需要调整
            const adjustedPage = page + 1; // 从第3页开始
            apiUrl = `/douban?action=subjects&type=movie&tag=热门&page_limit=20&page_start=${(adjustedPage - 1) * 20}`;
          }
        } else {
          // 豆瓣搜索接口
          apiUrl = `/douban?action=search&wd=${encodeURIComponent(keyword)}&page=${page}`;
        }
      } else {
        // 使用新的统一搜索接口
        const params = new URLSearchParams();
        params.set('source', src.code);
        if (isLatest) {
          params.set('latest', 'true');
        } else if (keyword) {
          params.set('keyword', keyword);
        }
        if (page) {
          params.set('page', page);
        }
        apiUrl = `/api/source_search?${params.toString()}`;
      }
      
      // 尝试请求
      try {
        // 检查搜索是否已被取消
        if (searchId && searchId !== currentSearchId) {
          console.log(`搜索 ${searchId} 已被取消，跳过 ${src.name} 第${page}页`);
          return;
        }
        
        console.log(`请求 ${src.name} 第${page}页:`, apiUrl);
        
        const res = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
            'Accept-Encoding': 'identity'
          },
          signal: searchController ? searchController.signal : undefined
        });
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        let list = [];
        if (src.code === 'dbzy') {
          // 豆瓣数据格式
          if (isLatest && data && data.subjects && Array.isArray(data.subjects)) {
            list = data.subjects;
            // console.log(`豆瓣最新推荐第${page}页: 获取到 ${list.length} 个视频`);
          } else if (data && data.data && Array.isArray(data.data.list)) {
            list = data.data.list;
            // console.log(`豆瓣搜索结果第${page}页: 获取到 ${list.length} 个视频`);
          }
        } else {
          // 新的统一接口数据格式
          if (data && data.success && Array.isArray(data.data)) {
            list = data.data;
            // console.log(`统一接口第${page}页: 获取到 ${list.length} 个视频`);
          }
        }
        
        // 为每个视频添加来源信息
        list.forEach(v => {
          v.source_name = src.name;
		});
        
        // 检查搜索是否已被取消
        if (searchId && searchId !== currentSearchId) {
          console.log(`搜索 ${searchId} 已被取消，跳过结果处理 ${src.name} 第${page}页`);
          return;
        }
        
        // 立即返回结果
        onResult(list);
        
      } catch (error) {
        // 检查是否是取消错误
        if (error.name === 'AbortError') {
          console.log(`搜索源 ${src.name} 第${page}页被取消`);
          return;
        }
        
        // 检查搜索是否已被取消
        if (searchId && searchId !== currentSearchId) {
          console.log(`搜索 ${searchId} 已被取消，跳过错误处理 ${src.name} 第${page}页`);
          return;
        }
        
        console.error(`搜索源 ${src.name} 第${page}页失败:`, error);
        onResult([]); // 返回空结果
      }
    }
    
    // 豆瓣最新推荐连续获取两页数据
    async function searchDoubanLatestTwoPages(src, onResult, searchId = null) {
      try {
        console.log(`豆瓣最新推荐连续获取两页数据: ${src.name}`);
        
        // 检查搜索是否已被取消
        if (searchId && searchId !== currentSearchId) {
          console.log(`搜索 ${searchId} 已被取消，跳过豆瓣最新推荐`);
          return;
        }
        
        // 获取第一页
        const page1Url = `/douban?action=subjects&type=movie&tag=热门&page_limit=20&page_start=0`;
        const res1 = await fetch(page1Url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
            'Accept-Encoding': 'identity'
          },
          signal: searchController ? searchController.signal : undefined
        });
        
        if (!res1.ok) {
          throw new Error(`HTTP ${res1.status}: ${res1.statusText}`);
        }
        
        const data1 = await res1.json();
        let list1 = [];
        if (data1 && data1.subjects && Array.isArray(data1.subjects)) {
          list1 = data1.subjects;
        }
        
        // 检查搜索是否已被取消
        if (searchId && searchId !== currentSearchId) {
          console.log(`搜索 ${searchId} 已被取消，跳过豆瓣第二页`);
          return;
        }
        
        // 获取第二页
        const page2Url = `/douban?action=subjects&type=movie&tag=热门&page_limit=20&page_start=20`;
        const res2 = await fetch(page2Url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json, text/plain, */*',
            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
            'Accept-Encoding': 'identity'
          },
          signal: searchController ? searchController.signal : undefined
        });
        
        if (!res2.ok) {
          throw new Error(`HTTP ${res2.status}: ${res2.statusText}`);
        }
        
        const data2 = await res2.json();
        let list2 = [];
        if (data2 && data2.subjects && Array.isArray(data2.subjects)) {
          list2 = data2.subjects;
        }
        
        // 检查搜索是否已被取消
        if (searchId && searchId !== currentSearchId) {
          console.log(`搜索 ${searchId} 已被取消，跳过豆瓣结果处理`);
          return;
        }
        
        // 合并两页数据
        const combinedList = [...list1, ...list2];
        console.log(`豆瓣最新推荐连续获取两页完成: 第1页${list1.length}个，第2页${list2.length}个，总计${combinedList.length}个`);
        
        // 为每个视频添加来源信息
        combinedList.forEach(v => {
          v.source_name = src.name;
        });
        
        // 返回合并结果
        onResult(combinedList);
        
      } catch (error) {
        // 检查是否是取消错误
        if (error.name === 'AbortError') {
          console.log(`豆瓣最新推荐被取消`);
          return;
        }
        
        // 检查搜索是否已被取消
        if (searchId && searchId !== currentSearchId) {
          console.log(`搜索 ${searchId} 已被取消，跳过豆瓣错误处理`);
          return;
        }
        
        console.error(`豆瓣最新推荐连续获取两页失败:`, error);
        onResult([]); // 返回空结果
      }
    }
    
    // 渲染移动端搜索结果
    function renderMobileSearchResults(videos, keyword, isLatest) {
      console.log('渲染移动端搜索结果:', videos.length, '个视频, isLatest:', isLatest);
      
      // 应用过滤逻辑
      const filteredVideos = filterVideoContent(videos);
      console.log('过滤后的视频数量:', filteredVideos.length, '个');
      
      const searchGrid = document.getElementById('searchGridMobile');
      const header = document.getElementById('searchHeaderMobile');
      
      // 确保完全清空加载状态（包括搜索加载卡片）
      console.log('清空搜索网格，移除加载卡片');
      searchGrid.innerHTML = '';
      
      if (!filteredVideos.length) {
        if (isLatest) {
          header.innerHTML = `<span style='font-size:18px;font-weight:600;'>暂无最新视频</span>`;
          searchGrid.innerHTML = `<div class="no-results"><div class="no-results-icon">📺</div><div style="margin-bottom: 8px; font-weight: 600;">暂无最新视频</div><div style="font-size: 14px; color: #888;">请稍后再试或更换视频源</div></div>`;
        } else {
          header.innerHTML = `<span style='font-size:18px;font-weight:600;'>未找到相关视频</span>`;
          searchGrid.innerHTML = `<div class="no-results"><div class="no-results-icon">🔍</div><div style="margin-bottom: 8px; font-weight: 600;">未找到相关视频</div><div style="font-size: 14px; color: #888;">请尝试更换关键词或视频源</div></div>`;
        }
        return;
      }
      
      // 更新标题栏
      if (isLatest) {
        header.innerHTML = `<span style="font-size:18px;font-weight:600;">源的最新推荐</span>`;
      } else if (window._lastSearchInfo) {
        const t = window._lastSearchInfo;
        header.innerHTML = `
          <span class="meta-badge type">${t.type}</span>
          ${t.tag ? `<span class="meta-badge tag">${t.tag}</span>` : ''}
          ${t.rate ? `<span class="meta-badge rate">★ ${t.rate}</span>` : ''}
          <span style="font-size:18px;font-weight:600;margin-left:8px;">${t.keyword}</span>
        `;
      }
      
      // 渲染搜索结果
      filteredVideos.forEach(video => {
        
        // 根据数据源处理不同的字段名
        let title, cover, year, type, rate;
        
        if (video.source_name === '豆瓣资源' || video.source_name === 'dbzy') {
          // 豆瓣数据格式
          title = video.title || '未知标题';
          cover = video.cover || '';
          year = video.year || '';
          type = '电影';
          rate = video.rate || '';
        } else {
          // 其他视频源数据格式
          title = video.vod_name || video.title || '未知标题';
          cover = video.vod_pic || video.cover || '';
          year = video.vod_year || video.year || '';
          type = video.type_name || video.type || '';
          rate = video.vod_score || video.rate || '';
        }
        
        // 确定最终图片URL
        const finalCoverUrl = (cover && cover.trim() && !cover.includes('placeholder.com')) 
          ? cover 
          : getDefaultSvgUrl();
        
        const source = video.source_name || '';
        
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <img class="video-cover" src="${finalCoverUrl}" alt="${title}" loading="lazy" referrerpolicy="no-referrer" onerror="handleImageError(this);">
          <div class="video-info">
            <div class="video-title">${title}</div>
            <div class="video-meta">
              ${type ? `<span class="meta-badge type">${type}</span>` : ''}
              ${year ? `<span class="meta-badge year">${year}</span>` : ''}
              ${rate ? `<span class="meta-badge rate">★ ${rate}</span>` : ''}
              ${source ? `<span class="meta-badge tag">${source}</span>` : ''}
            </div>
          </div>
        `;
        
        // 点击搜索结果卡片，打开播放器
        card.addEventListener('click', () => {
          console.log('点击搜索结果:', title);
          
          // 构建视频对象
          const videoObj = {
            vod_name: title,
            vod_pic: cover,
            vod_year: year,
            type_name: type,
            vod_score: rate,
            vod_content: video.vod_content || '',
            vod_play_url: video.vod_play_url || '',
            vod_play_from: video.vod_play_from || '',
            vod_play_note: video.vod_play_note || '',
            vod_actor: video.vod_actor || video.actor || '',
            vod_director: video.vod_director || video.director || ''
          };
          
          // 打开播放器
          openPlayerLayer(videoObj, source);
        });
        
        searchGrid.appendChild(card);
      });
    }
    
    // 渲染单个源的结果
    function renderSourceResults(videos, sourceName, isFirstResult) {
      console.log(`渲染源 ${sourceName} 的结果:`, videos.length, '个视频, isFirstResult:', isFirstResult);
      
      // 应用过滤逻辑
      const filteredVideos = filterVideoContent(videos);
      console.log(`源 ${sourceName} 过滤后的视频数量:`, filteredVideos.length, '个');
      
      const searchGrid = document.getElementById('searchGridMobile');
      
      // 只有在第一个源的第一个结果时才清空加载状态
      if (isFirstResult) {
        console.log('清空搜索网格，准备显示第一个源的结果');
        searchGrid.innerHTML = '';
      }
      
      // 渲染这个源的视频
      filteredVideos.forEach(video => {
        
        // 根据数据源处理不同的字段名
        let title, cover, year, type, rate;
        
        if (video.source_name === '豆瓣资源' || video.source_name === 'dbzy') {
          // 豆瓣数据格式
          title = video.title || '未知标题';
          cover = video.cover || '';
          year = video.year || '';
          type = '电影';
          rate = video.rate || '';
        } else {
          // 其他视频源数据格式
          title = video.vod_name || video.title || '未知标题';
          cover = video.vod_pic || video.cover || '';
          year = video.vod_year || video.year || '';
          type = video.type_name || video.type || '';
          rate = video.vod_score || video.rate || '';
        }
        
        // 确定最终图片URL
        const finalCoverUrl = (cover && cover.trim() && !cover.includes('placeholder.com')) 
          ? cover 
          : getDefaultSvgUrl();
        
        const source = video.source_name || '';
        
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <img class="video-cover" src="${finalCoverUrl}" alt="${title}" loading="lazy" referrerpolicy="no-referrer" onerror="handleImageError(this);">
          <div class="video-info">
            <div class="video-title">${title}</div>
            <div class="video-meta">
              ${type ? `<span class="meta-badge type">${type}</span>` : ''}
              ${year ? `<span class="meta-badge year">${year}</span>` : ''}
              ${rate ? `<span class="meta-badge rate">★ ${rate}</span>` : ''}
              ${source ? `<span class="meta-badge tag">${source}</span>` : ''}
            </div>
          </div>
        `;
        
        // 点击搜索结果卡片，打开播放器
        card.addEventListener('click', () => {
          console.log('点击搜索结果:', title);
          
          // 构建视频对象
          const videoObj = {
            vod_name: title,
            vod_pic: cover,
            vod_year: year,
            type_name: type,
            vod_score: rate,
            vod_content: video.vod_content || '',
            vod_play_url: video.vod_play_url || '',
            vod_play_from: video.vod_play_from || '',
            vod_play_note: video.vod_play_note || '',
            vod_actor: video.vod_actor || video.actor || '',
            vod_director: video.vod_director || video.director || ''
          };
          
          // 打开播放器
          openPlayerLayer(videoObj, source);
        });
        
        searchGrid.appendChild(card);
      });
    }
    
    // 返回推荐
    function hideSearchResultsWithSlide() {
      // 取消正在进行的搜索
      cleanupSearch();
      
      var searchResults = document.getElementById('searchResultsMobile');
      var recommendSection = document.getElementById('recommendSectionMobile');
      searchResults.classList.remove('slide-in');
      searchResults.classList.add('slide-out');
      
      // 隐藏返回按钮
      hideGlobalBackBtn();
      
      // 获取保存的滚动位置
      const savedScrollY = window._lastRecommendScrollY;
      console.log('准备恢复滚动位置:', savedScrollY);
      
      // 动画结束后隐藏
      setTimeout(function() {
        searchResults.style.display = 'none';
        recommendSection.style.display = 'block';
        var recommendHeader = document.getElementById('recommendHeaderMobile');
        if (recommendHeader) recommendHeader.style.display = '';
        
        // 清理搜索相关的滚动监听器
        if (window.handleSearchScroll) {
          window.removeEventListener('scroll', window.handleSearchScroll);
          window.handleSearchScroll = null;
          console.log('已清理搜索滚动监听器');
        }
        
        // 恢复滚动位置
        if (typeof savedScrollY === 'number' && savedScrollY >= 0) {
          console.log('开始恢复滚动位置到:', savedScrollY);
          let tries = 0;
          const maxTries = 10;
          const targetY = savedScrollY;
          
          function tryScroll() {
            window.scrollTo({ top: targetY, behavior: 'auto' });
            tries++;
            console.log(`尝试恢复滚动位置 ${tries}/${maxTries}: ${targetY}`);
            if (tries < maxTries) {
              setTimeout(tryScroll, 100);
            } else {
              console.log('滚动位置恢复完成');
              // 清理保存的滚动位置
              window._lastRecommendScrollY = undefined;
            }
          }
          
          // 延迟一点时间确保DOM更新完成
          setTimeout(tryScroll, 50);
        } else {
          console.log('没有保存的滚动位置，滚动到顶部');
          window.scrollTo({ top: 0, behavior: 'auto' });
        }
      }, 350);
    }

    document.addEventListener('DOMContentLoaded', function() {
    });

    // 支持手机滑动返回
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let isPlayerLayerSliding = false;
    
    document.addEventListener('touchstart', function(e) {
      if (e.touches.length === 1) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        isPlayerLayerSliding = false;
      }
    }, {passive: true});

    document.addEventListener('touchmove', function(e) {
      if (e.touches.length === 1) {
        const touchX = e.touches[0].clientX;
        const touchY = e.touches[0].clientY;
        const deltaX = touchX - touchStartX;
        const deltaY = Math.abs(touchY - touchStartY);
        
        // 检查播放层是否可见
      const playerLayer = document.getElementById('playerLayerMobile');
        if (playerLayer && playerLayer.style.display !== 'none') {
          // 确保是水平滑动（垂直滑动距离小于水平滑动距离的一半）
          if (deltaX > 0 && deltaX > deltaY * 2) {
            isPlayerLayerSliding = true;
            // 添加滑动类，启用快速过渡动画
            playerLayer.classList.add('sliding');
            // 根据滑动距离设置transform，使用与搜索区相同的效果
            const translateX = Math.min(deltaX * 0.5, 150); // 增加滑动响应度
            playerLayer.style.transform = `translateX(${translateX}px)`;
            e.preventDefault(); // 防止页面滚动
          }
        }
      }
    }, {passive: false});
    
    document.addEventListener('touchend', function(e) {
      if (e.changedTouches.length === 1) {
        touchEndX = e.changedTouches[0].clientX;
        const swipeDistance = touchEndX - touchStartX;
        
        // 处理播放层滑动
        const playerLayer = document.getElementById('playerLayerMobile');
        if (playerLayer && playerLayer.style.display !== 'none' && isPlayerLayerSliding) {
          // 移除滑动类，恢复正常过渡动画
          playerLayer.classList.remove('sliding');
          
          if (swipeDistance > 60) {
            console.log('检测到播放层右滑，关闭播放层');
            // 使用滑动退出效果
            playerLayer.classList.remove('slide-in');
            playerLayer.classList.add('slide-out');
            // 隐藏返回按钮
            hideGlobalBackBtn();
            // 动画结束后隐藏
            setTimeout(() => {
              playerLayer.style.display = 'none';
              playerLayer.classList.remove('slide-out');
              // 显示搜索结果层
              showSearchResultsLayer();
            }, 350);
            return;
      } else {
            // 滑动距离不够，平滑回到原位
            playerLayer.style.transform = 'translateX(0)';
            // 短暂延迟后清除transform
          setTimeout(() => {
              playerLayer.style.transform = '';
            }, 300);
          }
          return;
        }
        
        // 检查搜索结果层是否可见，如果右滑距离足够就返回推荐
        if (document.getElementById('searchResultsMobile').style.display !== 'none' && swipeDistance > 60) {
          hideSearchResultsWithSlide();
        }
      }
    }, {passive: true});




    
    // 异步检测剧集类型
    async function detectEpisodeType(url, buttonElement) {
      try {
        buttonElement.classList.add('episode-loading');
        
        const mediaType = await detectMediaType(url);
        
        buttonElement.classList.remove('episode-loading');
        buttonElement.setAttribute('data-media-type', mediaType);
        buttonElement.setAttribute('data-play-type', 
          (mediaType === 'hls' || mediaType === 'video') ? 'stream' : 'page'
        );
        
        // 更新按钮显示
        if (mediaType === 'hls') {
          buttonElement.style.borderLeft = '3px solid #4CAF50';
          buttonElement.title = 'HLS流媒体';
        } else if (mediaType === 'video') {
          buttonElement.style.borderLeft = '3px solid #4CAF50';
          buttonElement.title = '视频流';
        } else {
          buttonElement.style.borderLeft = '3px solid #FF9800';
          buttonElement.title = '网页播放';
        }
        
        console.log(`剧集类型检测完成: ${mediaType}`);
        return mediaType; // 返回检测结果
        
      } catch (error) {
        console.error('检测剧集类型失败:', error);
        buttonElement.classList.remove('episode-loading');
        buttonElement.setAttribute('data-media-type', 'error');
        buttonElement.style.borderLeft = '3px solid #f44336';
        buttonElement.title = '检测失败';
        throw error; // 抛出错误
      }
    }

    // 清理上一个播放器的状态
    async function cleanupPreviousPlayer(videoEl, iframeEl) {
      console.log('清理上一个播放器状态');
      
      // 清理HLS实例
      if (window._mobileHlsInstance) {
        console.log('销毁HLS实例');
        window._mobileHlsInstance.destroy();
        window._mobileHlsInstance = null;
      }
      
      // 暂停并清理视频元素
      if (videoEl) {
        try {
          videoEl.pause();
          videoEl.currentTime = 0;
          videoEl.src = '';
          videoEl.load();
          
          // 移除所有事件监听器
          videoEl.onerror = null;
          videoEl.onloadstart = null;
          videoEl.oncanplay = null;
          videoEl.onended = null;
          videoEl.ontimeupdate = null;
          videoEl.onplaying = null;
          videoEl.onplay = null;
          videoEl.onpause = null;
          videoEl.onwaiting = null;
          videoEl.onstalled = null;
          
          console.log('视频元素已清理');
        } catch (error) {
          console.error('清理视频元素时出错:', error);
        }
      }
      
      // 清理iframe元素
      if (iframeEl) {
        try {
          // 移除iframe事件监听器
          iframeEl.onload = null;
          iframeEl.onerror = null;
          iframeEl.src = 'about:blank';
          console.log('iframe元素已清理');
        } catch (error) {
          console.error('清理iframe元素时出错:', error);
        }
      }
      
      // 等待一小段时间确保清理完成
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    // 解析播放地址 - 兼容多线路多剧集
    function parseVodPlayUrl(vod_play_url, vod_play_from, vod_play_note) {
      const play_urls = [];
      if (!vod_play_url) return play_urls;

      const lines = vod_play_url.split('$$$');
      const notes = (vod_play_note || '').split('$$$');
      const froms = (vod_play_from || '').split('$$$');

      for (let line_idx = 0; line_idx < lines.length; line_idx++) {
        const line = lines[line_idx];
        const line_name = froms[line_idx] ? froms[line_idx] : `线路${line_idx+1}`;
        const note = notes[line_idx] ? notes[line_idx] : '';
        const episodes = line.split('#');

        for (const ep of episodes) {
          if (ep.includes('$')) {
            const parts = ep.split('$');
            if (parts.length === 2) {
              const ep_name = parts[0].trim();
              const ep_url = parts[1].trim();
              play_urls.push({
                name: ep_name,
                url: ep_url,
                line: line_name,
                quality: note,
                realUrl: ep_url
              });
            }
          } else if (ep.trim()) {
            play_urls.push({
              name: '播放',
              url: ep.trim(),
              line: line_name,
              quality: note,
              realUrl: ep.trim()
            });
          }
        }
      }

      if (play_urls.length === 0 && vod_play_url) {
        play_urls.push({
          name: '播放',
          url: vod_play_url,
          line: '',
          quality: '',
          realUrl: vod_play_url
        });
      }

      return play_urls;
    }

    // 媒体类型检测函数 - 只用扩展名和域名判断
    async function detectMediaType(url) {
      const urlLower = url.toLowerCase();
      if (urlLower.endsWith('.m3u8') || urlLower.endsWith('.ts')) return 'hls';
      if (urlLower.endsWith('.mp4') || urlLower.endsWith('.avi') || urlLower.endsWith('.mkv') ||
          urlLower.endsWith('.mov') || urlLower.endsWith('.wmv') || urlLower.endsWith('.flv') ||
          urlLower.endsWith('.webm') || urlLower.endsWith('.ogg')) return 'video';
      // 常见视频网站
      const videoDomains = [
        'youtube.com', 'youtu.be', 'vimeo.com', 'dailymotion.com',
        'bilibili.com', 'iqiyi.com', 'youku.com', 'mgtv.com',
        'le.com', 'pptv.com', 'sohu.com', '1905.com'
      ];
      if (videoDomains.some(domain => urlLower.includes(domain))) return 'html';
      // 兜底
      return 'html';
    }

    // 自动修复首页侧边栏按钮可点击性
    function fixMenuBtnSidebar() {
      const btn = document.getElementById('menuBtn');
      if (btn) {
        btn.style.pointerEvents = 'auto';
        btn.style.zIndex = '10010';
        btn.disabled = false;
      }
    }
    window.addEventListener('DOMContentLoaded', fixMenuBtnSidebar);
    window.addEventListener('resize', fixMenuBtnSidebar);

    // 更强力修复首页侧边栏按钮可点击性，移除遮挡
    function forceFixMenuBtn() {
      const btn = document.getElementById('menuBtn');
      if (!btn) return;
      // 强制提升z-index和pointer-events
      btn.style.zIndex = '99999';
      btn.style.pointerEvents = 'auto';
      btn.disabled = false;

      // 检查并移除所有覆盖在按钮上的高z-index元素
      const btnRect = btn.getBoundingClientRect();
      document.querySelectorAll('body > *').forEach(el => {
        if (el === btn || el.id === 'sidebar' || el.id === 'toastContainer') return;
        if (el.style && el.style.zIndex && parseInt(el.style.zIndex) > 1000) {
          const elRect = el.getBoundingClientRect();
          // 判断是否覆盖在按钮上
          if (
            elRect.left < btnRect.right &&
            elRect.right > btnRect.left &&
            elRect.top < btnRect.bottom &&
            elRect.bottom > btnRect.top
          ) {
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.5';
            el.setAttribute('data-debug-overlay', 'true');
            console.warn('检测到覆盖menuBtn的高z-index元素，已禁用pointerEvents:', el);
          }
        }
      });
    }
    window.addEventListener('DOMContentLoaded', forceFixMenuBtn);
    window.addEventListener('resize', forceFixMenuBtn);
    setInterval(forceFixMenuBtn, 2000); // 定时修复

    // 增强：点击侧边栏以外区域自动收起侧边栏（排除menuBtn）
    window.addEventListener('click', function(e) {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      const menuBtn = document.getElementById('menuBtn');
      if (menuBtn) {
        menuBtn.style.zIndex = '10010';
        menuBtn.style.pointerEvents = 'auto';
        menuBtn.disabled = false;
      }
      if (!sidebar || !sidebar.classList.contains('active')) return;
      // 如果点击的不是侧边栏本身、不是侧边栏的子元素、不是menuBtn
      if (!sidebar.contains(e.target) && e.target !== overlay && e.target !== menuBtn) {
        closeSidebar();
      }
    });

    // 删除重复的函数定义和事件绑定，这些已经在 bindEvents() 中处理了

    // 播放层相关函数
    let currentVideoData = null;
    let searchScrollPosition = 0;

    // 打开播放层
    function openPlayerLayer(videoObj, source) {
      console.log('打开播放层:', videoObj);
      
      // 保存当前视频数据
      currentVideoData = { ...videoObj, source };
      
      // 保存搜索结果层的滚动位置
      const searchResults = document.getElementById('searchResultsMobile');
      if (searchResults && searchResults.style.display !== 'none') {
        searchScrollPosition = window.scrollY;
        console.log('保存搜索结果滚动位置:', searchScrollPosition);
      }
      
      // 更新播放层内容
      updatePlayerLayerContent(videoObj, source);
      
      // 隐藏搜索结果层
      hideSearchResultsLayer();
      
      // 显示播放层
      showPlayerLayer();
    }

    // 更新播放层内容
    function updatePlayerLayerContent(videoObj, source) {
      const playerVideoCoverHeader = document.getElementById('playerVideoCoverHeader');
      const playerVideoTitleHeader = document.getElementById('playerVideoTitleHeader');
      const playerVideoMetaHeader = document.getElementById('playerVideoMetaHeader');
      const playerVideoDescription = document.getElementById('playerVideoDescription');
      
      // 更新标题
      const title = videoObj.vod_name || videoObj.title || '未知标题';
      if (playerVideoTitleHeader) playerVideoTitleHeader.textContent = title;
      
      // 更新封面
      const cover = videoObj.vod_pic || videoObj.cover || '';
      const finalCoverUrl = cover && cover.trim() && !cover.includes('placeholder.com') 
        ? cover 
        : getDefaultSvgUrl();
      if (playerVideoCoverHeader) {
        playerVideoCoverHeader.src = finalCoverUrl;
        playerVideoCoverHeader.alt = title;
      }
      
      // 更新元信息
      const year = videoObj.vod_year || videoObj.year || '';
      const type = videoObj.type_name || videoObj.type || '';
      const rate = videoObj.vod_score || videoObj.rate || '';
      
      let metaHTML = '';
      if (source) {
        metaHTML += `<span class="player-header-badge source">${source}</span>`;
      }
      if (type) {
        metaHTML += `<span class="player-header-badge type">${type}</span>`;
      }
      if (rate) {
        metaHTML += `<span class="player-header-badge rate">★ ${rate}</span>`;
      }
      if (year) {
        metaHTML += `<span class="player-header-badge year">${year}</span>`;
      }
      
      // 添加分辨率占位符，将在视频加载后更新
      metaHTML += `<span class="player-header-badge resolution" id="videoResolutionBadge" style="display:none;">分辨率检测中...</span>`;
      
      if (playerVideoMetaHeader) playerVideoMetaHeader.innerHTML = metaHTML;
      
      // 初始化分辨率显示
      const resolutionBadge = document.getElementById('videoResolutionBadge');
      if (resolutionBadge) {
        resolutionBadge.textContent = '分辨率检测中...';
        resolutionBadge.style.display = 'inline-block';
      }
      
      // 更新介绍信息
      const description = videoObj.vod_content || videoObj.content || '';
      if (description && description.trim()) {
        const descriptionText = formatDescription(description.trim());
        const isLong = descriptionText.length > 200; // 调整阈值
        
        if (playerVideoDescription) {
          playerVideoDescription.textContent = descriptionText;
          playerVideoDescription.className = `video-description-text${isLong ? '' : ' expanded'}`;
        }
        
        // 显示/隐藏展开按钮
        const toggleBtn = document.querySelector('.video-description-toggle');
        if (toggleBtn) {
          toggleBtn.style.display = isLong ? 'inline-block' : 'none';
        }
      } else {
        if (playerVideoDescription) {
          playerVideoDescription.textContent = '暂无介绍信息';
          playerVideoDescription.className = 'video-description-text expanded';
        }
        const toggleBtn = document.querySelector('.video-description-toggle');
        if (toggleBtn) {
          toggleBtn.style.display = 'none';
        }
      }

      // ================== 剧集分类渲染（参照index.html） ==================
      const episodeListStream = document.getElementById('episodeListStream');
      const episodeListPage = document.getElementById('episodeListPage');
      const tabStream = document.getElementById('tabStream');
      const tabPage = document.getElementById('tabPage');
      
      // 清空现有内容
      if (episodeListStream) episodeListStream.innerHTML = '';
      if (episodeListPage) episodeListPage.innerHTML = '';
      
      if (videoObj.vod_play_url) {
        // 解析播放地址
        const playUrls = parseVodPlayUrl(videoObj.vod_play_url, videoObj.vod_play_from, videoObj.vod_play_note);
        
        if (playUrls.length > 0) {
          // 统计各类型数量
          let streamCount = 0;
          let pageCount = 0;
          let defaultStreamIndex = -1;
          let defaultPageIndex = -1;
          
          // 生成剧集按钮
          playUrls.forEach((ep, idx) => {
            const mediaType = detectMediaTypeSync(ep.url);
            const isStream = mediaType === 'hls' || mediaType === 'video';
            
            const buttonHTML = `
              <button class="episode-btn" 
                      data-url="${ep.url}" 
                      data-index="${idx}" 
                      data-media-type="${mediaType}"
                      data-play-type="${isStream ? 'stream' : 'page'}">
                ${ep.name}
              </button>
            `;
            
            if (isStream) {
              if (episodeListStream) episodeListStream.innerHTML += buttonHTML;
              streamCount++;
              // 记录第一个流媒体地址作为默认选择
              if (defaultStreamIndex === -1) {
                defaultStreamIndex = idx;
              }
            } else {
              if (episodeListPage) episodeListPage.innerHTML += buttonHTML;
              pageCount++;
              // 记录第一个页面地址作为备用
              if (defaultPageIndex === -1) {
                defaultPageIndex = idx;
              }
            }
          });
          
          // 更新标签显示
          if (streamCount > 0) {
            if (tabStream) {
              tabStream.textContent = `流媒体 (${streamCount})`;
              tabStream.style.display = 'block';
            }
            if (tabPage) tabPage.classList.remove('active');
            if (episodeListStream) episodeListStream.style.display = 'flex';
            if (episodeListPage) episodeListPage.style.display = 'none';
            // 默认激活流媒体标签
            if (tabStream) tabStream.classList.add('active');
          } else {
            if (tabStream) tabStream.style.display = 'none';
          }
          
          if (pageCount > 0) {
            if (tabPage) {
              tabPage.textContent = `页面源 (${pageCount})`;
              tabPage.style.display = 'block';
            }
            // 如果没有流媒体，激活页面源标签
            if (streamCount === 0) {
              if (tabPage) tabPage.classList.add('active');
              if (tabStream) tabStream.classList.remove('active');
              if (episodeListPage) episodeListPage.style.display = 'flex';
              if (episodeListStream) episodeListStream.style.display = 'none';
            }
          } else {
            if (tabPage) tabPage.style.display = 'none';
          }
          
          // 绑定剧集按钮点击事件
          bindEpisodeButtonEvents();
          bindEpisodeTabEvents();
          
          // 自动播放第一个流媒体地址（优先）或第一个页面地址
          setTimeout(() => {
            const defaultIndex = defaultStreamIndex !== -1 ? defaultStreamIndex : defaultPageIndex;
            if (defaultIndex !== -1) {
              const defaultBtn = document.querySelector(`.episode-btn[data-index="${defaultIndex}"]`);
              if (defaultBtn) {
                console.log('自动播放默认剧集:', playUrls[defaultIndex].name);
                // 设置按钮为激活状态
                defaultBtn.classList.add('active');
                // 播放剧集
                playMobileEpisode(playUrls[defaultIndex].url, defaultBtn);
                
                // 预加载后续剧集
                if (playUrls.length > 1) {
                  setTimeout(() => {
                    preloadNextEpisode(defaultIndex, playUrls);
                  }, 2000);
                }
              }
            }
          }, 500);
        }
      }
      
      // ================== 演员信息渲染 ==================
      const castList = document.getElementById('castList');
      if (castList) {
        castList.innerHTML = '';
        
        // 处理演员信息
        const actors = [];
        const directors = [];
        
        // 解析演员信息
        if (videoObj.vod_actor) {
          const actorList = videoObj.vod_actor.split(',').map(a => a.trim()).filter(a => a);
          actors.push(...actorList.slice(0, 6)); // 最多显示6个演员
        }
        
        // 解析导演信息
        if (videoObj.vod_director) {
          const directorList = videoObj.vod_director.split(',').map(d => d.trim()).filter(d => d);
          directors.push(...directorList.slice(0, 3)); // 最多显示3个导演
        }
        
        // 合并所有人员信息
        const allCast = [];
        
        // 先添加导演
        directors.forEach(director => {
          allCast.push({
            name: director,
            role: '导演',
            avatarColor: 'linear-gradient(135deg, #6c63ff, #8b5cf6)',
            shadowColor: 'rgba(108,99,255,0.3)'
          });
        });
        
        // 再添加演员
        actors.forEach(actor => {
          allCast.push({
            name: actor,
            role: '演员',
            avatarColor: 'linear-gradient(135deg, #ff6b6b, #ff8e53)',
            shadowColor: 'rgba(255,107,107,0.3)'
          });
        });
        
        // 渲染演员卡片
        if (allCast.length > 0) {
          allCast.forEach(person => {
            const castCard = document.createElement('div');
            castCard.className = 'cast-card';
            
            const firstChar = person.name.charAt(0);
            const avatarStyle = `background: ${person.avatarColor}; box-shadow: 0 4px 12px ${person.shadowColor};`;
            
            // 使用 encodeURIComponent 和 btoa 的组合来处理中文字符
            const svgString = `
              <svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg">
                <circle cx="30" cy="30" r="30" fill="url(#gradient)"/>
                <defs>
                  <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:${person.avatarColor.split(',')[0].replace('linear-gradient(135deg, ', '').replace(')', '')};stop-opacity:1" />
                    <stop offset="100%" style="stop-color:${person.avatarColor.split(',')[1].replace(')', '')};stop-opacity:1" />
                  </linearGradient>
                </defs>
                <text x="30" y="35" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="white">${firstChar}</text>
              </svg>
            `;
            
            // 使用 encodeURIComponent 处理中文字符，然后转换为 base64
            const encodedSvg = btoa(unescape(encodeURIComponent(svgString)));
            
            castCard.innerHTML = `
              <img class="cast-avatar" src="data:image/svg+xml;base64,${encodedSvg}" alt="${person.name}" style="${avatarStyle}">
              <div class="cast-name">${person.name}</div>
              <div class="cast-role">${person.role}</div>
            `;
            
            castList.appendChild(castCard);
          });
        } else {
          // 如果没有演员信息，显示提示
          castList.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; color: #b3b6d4; padding: 20px;">
              <div style="font-size: 14px;">暂无演员信息</div>
            </div>
          `;
        }
      }
      // =====================================================
    }

    // 显示播放层
    function showPlayerLayer() {
      const playerLayer = document.getElementById('playerLayerMobile');
      if (playerLayer) {
        playerLayer.style.display = 'block';
        // 重置transform状态
        playerLayer.style.transform = '';
        playerLayer.classList.remove('slide-out');
        // 显示返回按钮
        showGlobalBackBtn('player');
        // 触发动画
        setTimeout(() => {
          playerLayer.classList.add('slide-in');
        }, 10);
        
        // iOS设备显示播放层时检查页面缩放
        const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
        if (isIOS) {
          console.log('显示播放层时检查页面缩放');
          setTimeout(() => restorePageZoom(), 100);
        }
      }
    }

    // 隐藏播放层
    function hidePlayerLayer() {
      const playerLayer = document.getElementById('playerLayerMobile');
      if (playerLayer) {
        playerLayer.classList.remove('slide-in');
        playerLayer.classList.add('slide-out');
        // 隐藏返回按钮
        hideGlobalBackBtn();
        // 动画结束后隐藏
        setTimeout(() => {
          playerLayer.style.display = 'none';
          playerLayer.classList.remove('slide-out');
          
          // iOS设备隐藏播放层时检查页面缩放
          const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
          if (isIOS) {
            console.log('隐藏播放层时检查页面缩放');
            restorePageZoom();
          }
        }, 350);
      }
    }

    // 隐藏搜索结果层
    function hideSearchResultsLayer() {
      const searchResults = document.getElementById('searchResultsMobile');
      if (searchResults) {
        searchResults.classList.remove('slide-in');
        searchResults.classList.add('slide-out');
        // 隐藏返回按钮
        hideGlobalBackBtn();
        // 动画结束后隐藏
        setTimeout(() => {
          searchResults.style.display = 'none';
          
          // iOS设备隐藏搜索结果层时检查页面缩放
          const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
          if (isIOS) {
            console.log('隐藏搜索结果层时检查页面缩放');
            restorePageZoom();
          }
        }, 350);
      }
    }

    // 显示搜索结果层
    function showSearchResultsLayer() {
      const searchResults = document.getElementById('searchResultsMobile');
      if (searchResults) {
        console.log('显示搜索结果层');
        
        // 确保搜索层可见
        searchResults.style.display = 'block';
        searchResults.classList.remove('slide-out');
        searchResults.classList.add('slide-in');
        
        // 隐藏推荐层（如果可见）
        const recommendSection = document.getElementById('recommendSectionMobile');
        if (recommendSection) {
          recommendSection.style.display = 'none';
        }
        
        // 显示返回按钮
        showGlobalBackBtn('search');
        
        // iOS设备显示搜索结果层时检查页面缩放
        const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
        if (isIOS) {
          console.log('显示搜索结果层时检查页面缩放');
          setTimeout(() => restorePageZoom(), 100);
        }
        
        // 恢复滚动位置
        setTimeout(() => {
          if (typeof searchScrollPosition === 'number' && searchScrollPosition >= 0) {
            console.log('恢复搜索结果滚动位置:', searchScrollPosition);
            window.scrollTo({ top: searchScrollPosition, behavior: 'auto' });
          } else {
            // 如果没有保存的滚动位置，滚动到顶部
            window.scrollTo({ top: 0, behavior: 'auto' });
          }
        }, 100);
      } else {
        console.error('未找到搜索结果层元素');
      }
    }

    // 返回搜索结果
    function backToSearchResults() {
      console.log('返回搜索结果');
      hidePlayerLayer();
      showSearchResultsLayer();
    }

    // 格式化介绍信息
    function formatDescription(text) {
      if (!text) return '';
      
      // 移除多余的空白字符和特殊字符
      let formatted = text.replace(/\s+/g, ' ').trim();
      
      // 移除常见的无意义字符
      formatted = formatted.replace(/[　]/g, ''); // 全角空格
      
      // 处理常见的分隔符，统一为换行
      formatted = formatted.replace(/[。！？；]/g, '$&\n');
      
      // 处理段落分隔
      formatted = formatted.replace(/\n+/g, '\n');
      
      // 移除开头和结尾的换行
      formatted = formatted.replace(/^\n+|\n+$/g, '');
      
      return formatted;
    }

    // 展开/收起介绍信息
    function toggleDescription() {
      const descriptionText = document.querySelector('.video-description-text');
      const toggleBtn = document.querySelector('.video-description-toggle');
      
      if (descriptionText && toggleBtn) {
        const isExpanded = descriptionText.classList.contains('expanded');
        
        if (isExpanded) {
          descriptionText.classList.remove('expanded');
          toggleBtn.textContent = '展开更多';
        } else {
          descriptionText.classList.add('expanded');
          toggleBtn.textContent = '收起';
        }
      }
    }
    
    // 全屏切换功能
    function toggleFullscreen() {
      const playerContainer = document.querySelector('.player-container');
      if (!playerContainer) return;
      
      if (!document.fullscreenElement) {
        // 进入全屏
        if (playerContainer.requestFullscreen) {
          playerContainer.requestFullscreen();
        } else if (playerContainer.webkitRequestFullscreen) {
          playerContainer.webkitRequestFullscreen();
        } else if (playerContainer.msRequestFullscreen) {
          playerContainer.msRequestFullscreen();
        }
      } else {
        // 退出全屏
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }

    // 全局返回按钮状态管理
    let currentBackAction = null;

    // 显示全局返回按钮
    function showGlobalBackBtn(action) {
      const backBtn = document.getElementById('globalBackBtn');
      const aboutBtn = document.getElementById('aboutBtn');
      if (backBtn) {
        backBtn.style.display = 'flex';
        currentBackAction = action;
        console.log('显示全局返回按钮，动作:', action);
        console.log('返回按钮元素:', backBtn);
        console.log('返回按钮样式:', backBtn.style.display);
      } else {
        console.error('未找到全局返回按钮元素');
      }
      
      // 隐藏关于按钮
      if (aboutBtn) {
        aboutBtn.style.display = 'none';
        console.log('隐藏关于按钮');
      }
    }

    // 隐藏全局返回按钮
    function hideGlobalBackBtn() {
      const backBtn = document.getElementById('globalBackBtn');
      const aboutBtn = document.getElementById('aboutBtn');
      if (backBtn) {
        backBtn.style.display = 'none';
        currentBackAction = null;
        console.log('隐藏全局返回按钮');
      }
      
      // 显示关于按钮（回到豆瓣推荐页面）
      if (aboutBtn) {
        aboutBtn.style.display = 'flex';
        console.log('显示关于按钮');
      }
    }

    // 全局返回按钮点击处理
    function handleGlobalBack() {
      if (currentBackAction === 'search') {
        console.log('返回豆瓣推荐');
        // 取消正在进行的搜索
        cleanupSearch();
        hideSearchResultsWithSlide();
        hideGlobalBackBtn();
      } else if (currentBackAction === 'player') {
        console.log('返回搜索结果');
        backToSearchResults();
      }
      
      // iOS设备返回按钮点击时检查页面缩放
      const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
      if (isIOS) {
        console.log('返回按钮点击时检查页面缩放');
        setTimeout(() => restorePageZoom(), 100);
      }
    }

    // 绑定全局返回按钮事件
    document.addEventListener('DOMContentLoaded', function() {
      const globalBackBtn = document.getElementById('globalBackBtn');
      if (globalBackBtn) {
        globalBackBtn.addEventListener('click', handleGlobalBack);
      }
    });

    // ================== 剧集相关辅助函数（参照index.html） ==================
    
    // 解析播放地址
    function parseVodPlayUrl(vod_play_url, vod_play_from, vod_play_note) {
      const play_urls = [];
      if (!vod_play_url) return play_urls;
      
      const lines = vod_play_url.split('$$$');
      const notes = (vod_play_note || '').split('$$$');
      const froms = (vod_play_from || '').split('$$$');
      
      for (let line_idx = 0; line_idx < lines.length; line_idx++) {
        const line = lines[line_idx];
        const line_name = froms[line_idx] && froms[line_idx] ? froms[line_idx] : `线路${line_idx+1}`;
        const note = notes[line_idx] && notes[line_idx] ? notes[line_idx] : '';
        const episodes = line.split('#');
        
        for (const ep of episodes) {
          if (ep.includes('$')) {
            const parts = ep.split('$');
            if (parts.length === 2) {
              const ep_name = parts[0].trim();
              const ep_url = parts[1].trim();
              play_urls.push({
                name: ep_name,
                url: ep_url,
                line: line_name,
                quality: note,
                realUrl: ep_url
              });
            }
          } else if (ep.trim()) {
            play_urls.push({
              name: '播放',
              url: ep.trim(),
              line: line_name,
              quality: note,
              realUrl: ep.trim()
            });
          }
        }
      }
      
      if (play_urls.length === 0 && vod_play_url) {
        play_urls.push({
          name: '播放',
          url: vod_play_url,
          line: '',
          quality: '',
          realUrl: vod_play_url
        });
      }
      
      return play_urls;
    }
    
    // 同步媒体类型检测函数
    function detectMediaTypeSync(url) {
      const urlLower = url.toLowerCase();
      
      // 检查是否有视频文件扩展名
      const videoExtensions = [
        '.m3u8', '.ts', '.mp4', '.avi', '.mkv', '.mov', '.wmv', '.flv', '.webm', '.ogg'
      ];
      
      // 如果有扩展名，判断为流媒体
      if (videoExtensions.some(ext => urlLower.endsWith(ext))) {
        if (urlLower.endsWith('.m3u8') || urlLower.endsWith('.ts')) {
          return 'hls';
        } else {
          return 'video';
        }
      }
      
      // 没有扩展名的都作为页面源
      return 'html';
    }
    
    // 绑定剧集按钮事件
    function bindEpisodeButtonEvents() {
      const episodeBtns = document.querySelectorAll('.episode-btn');
      episodeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          // 重置所有按钮样式
          episodeBtns.forEach(b => {
            b.classList.remove('active');
          });
          
          // 设置当前按钮为激活状态
          this.classList.add('active');
          
          const url = this.getAttribute('data-url');
          const playType = this.getAttribute('data-play-type');
          
          console.log('点击剧集按钮:', {
            url: url,
            playType: playType,
            name: this.textContent
          });
          
          // 播放剧集
          playMobileEpisode(url, this);
        });
      });
    }
    
    // 绑定剧集标签切换事件
    function bindEpisodeTabEvents() {
      const tabStream = document.getElementById('tabStream');
      const tabPage = document.getElementById('tabPage');
      const episodeListStream = document.getElementById('episodeListStream');
      const episodeListPage = document.getElementById('episodeListPage');
      
      if (tabStream && tabPage && episodeListStream && episodeListPage) {
        // 流媒体标签点击
        tabStream.addEventListener('click', function() {
          // 更新标签状态
          tabStream.classList.add('active');
          tabPage.classList.remove('active');
          
          // 显示对应内容
          episodeListStream.style.display = 'flex';
          episodeListPage.style.display = 'none';
          
          console.log('切换到流媒体标签');
        });
        
        // 页面源标签点击
        tabPage.addEventListener('click', function() {
          // 更新标签状态
          tabPage.classList.add('active');
          tabStream.classList.remove('active');
          
          // 显示对应内容
          episodeListPage.style.display = 'flex';
          episodeListStream.style.display = 'none';
          
          console.log('切换到页面源标签');
        });
      }
    }
    
    // 移动端提示函数
    function showMobileToast(message, type = 'info', duration = 2000) {
      const container = document.getElementById('mobileToastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.style.cssText = `
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
      `;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      // 显示动画
      setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateY(0)';
      }, 10);
      
      // 自动隐藏
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }
        }, 300);
      }, duration);
    }
    
    // =====================================================
    
    // ================== 移动端播放器核心功能 ==================
    
    // 播放器相关状态
    let currentMobileEpisodeUrl = null;
    let currentMobileEpisodeButton = null;
    let currentMobileEpisodeType = null;
    let currentMobileEpisodeIndex = 0;
    
    // 播放器缓存系统
    const playerCache = {
      // 视频播放器缓存
      video: {
        element: null,
        hlsInstance: null,
        currentUrl: null,
        currentTime: 0,
        duration: 0,
        isReady: false
      },
      // iframe播放器缓存
      iframe: {
        element: null,
        currentUrl: null,
        isReady: false
      },
      // 缓存配置
      config: {
        maxCacheSize: 100 * 1024 * 1024, // 100MB缓存限制
        enableVideoCache: true,
        enableIframeCache: true,
        preloadNextEpisode: true
      }
    };
    
    // 播放剧集
    async function playMobileEpisode(url, buttonElement) {
      console.log('移动端播放剧集:', url);
      
      // 获取播放器元素
      const videoEl = document.getElementById('playerVideoMobile');
      const iframeEl = document.getElementById('playerIframeMobile');
      const loadingEl = document.getElementById('videoLoadingMobile');
      let errorEl = document.getElementById('videoErrorMobile');
      
      if (errorEl) errorEl.style.display = 'none';
      if (loadingEl) loadingEl.style.display = 'none';
      
      // 记录上一次播放类型
      let lastType = currentMobileEpisodeType;
      let lastUrl = currentMobileEpisodeUrl;
      
      // 保存当前播放的剧集信息
      currentMobileEpisodeUrl = url;
      currentMobileEpisodeButton = buttonElement;
      currentMobileEpisodeIndex = parseInt(buttonElement.getAttribute('data-index'));
      currentMobileEpisodeType = buttonElement.getAttribute('data-play-type');
      
      // 检测当前剧集类型
      const mediaType = await detectMediaType(url);
      if (!buttonElement.getAttribute('data-media-type')) {
        buttonElement.setAttribute('data-media-type', mediaType);
        buttonElement.setAttribute('data-play-type', (mediaType === 'hls' || mediaType === 'video') ? 'stream' : 'page');
      }
      currentMobileEpisodeType = buttonElement.getAttribute('data-play-type');
      
      console.log('媒体类型检测结果:', {
        url: url,
        mediaType: mediaType,
        playType: currentMobileEpisodeType
      });
      
      // 只在类型切换时重置另一个播放器，否则只切换src
      if (mediaType === 'html') {
        // 只在类型切换时重置video
        if (lastType !== 'page') {
          if (window._mobileHlsInstance) {
            window._mobileHlsInstance.destroy();
            window._mobileHlsInstance = null;
          }
          if (videoEl) {
            videoEl.pause();
            videoEl.removeAttribute('src');
            videoEl.load();
        videoEl.style.display = 'none';
            videoEl.style.visibility = 'hidden';
          }
        }
        
        // iframe切换src
        iframeEl.style.display = 'block';
        iframeEl.style.visibility = 'visible';
        if (iframeEl.src !== url) iframeEl.src = url;
        
        if (loadingEl) loadingEl.style.display = 'none';
        if (errorEl) errorEl.style.display = 'none';
        
        showMobileToast('检测到网页内容，使用嵌入模式播放', 'info');
        
      } else if (mediaType === 'hls' || mediaType === 'video') {
        // 只在类型切换时重置iframe
        if (lastType !== 'stream') {
          if (iframeEl) {
            iframeEl.src = 'about:blank';
            iframeEl.style.display = 'none';
            iframeEl.style.visibility = 'hidden';
          }
        }
        
        // video切换src
        videoEl.style.display = 'block';
        videoEl.style.visibility = 'visible';
        
        // 应用移动端视频优化
        setupMobileVideoOptimization(videoEl);
        
        // 检查是否有缓存的播放进度
        const cachedProgress = getPlaybackProgress(url);
        if (cachedProgress > 0) {
          showMobileToast(`发现播放进度: ${Math.floor(cachedProgress / 60)}分${Math.floor(cachedProgress % 60)}秒`, 'info', 3000);
        }
        
        if (window._mobileHlsInstance) {
          window._mobileHlsInstance.destroy();
          window._mobileHlsInstance = null;
        }
        
        if (mediaType === 'hls') {
          // 参照index.html的简化逻辑
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
          if (isSafari && videoEl.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari原生HLS支持
          videoEl.src = url;
          videoEl.setAttribute('webkit-playsinline', 'true');
          videoEl.setAttribute('playsinline', 'true');
          videoEl.setAttribute('x-webkit-airplay', 'allow');
          videoEl.setAttribute('webkit-airplay', 'allow');
          
          videoEl.oncanplay = () => {
              if (loadingEl) loadingEl.style.display = 'none';
              if (errorEl) errorEl.style.display = 'none';
              
              // 恢复播放进度
              if (cachedProgress > 0) {
                videoEl.currentTime = cachedProgress;
                showMobileToast('已恢复播放进度', 'success', 2000);
              }
              
              // 检测视频比例并应用相应样式
              detectAndApplyVideoAspectRatio(videoEl);
              
              // 更新视频分辨率显示
              updateVideoResolution(videoEl);
          };
          
          videoEl.onerror = (e) => {
              console.error('Safari原生HLS播放错误:', e);
              if (loadingEl) loadingEl.style.display = 'none';
              if (errorEl) errorEl.style.display = 'block';
              showMobileToast('Safari播放失败，尝试使用HLS.js', 'warning');
            if (typeof Hls !== 'undefined' && Hls.isSupported()) {
              playMobileWithHlsJs(url, videoEl, loadingEl, errorEl);
            }
          };
            
        } else if (typeof Hls !== 'undefined' && Hls.isSupported()) {
            // 使用HLS.js
            playMobileWithHlsJs(url, videoEl, loadingEl, errorEl, cachedProgress);
        } else {
            try {
              videoEl.src = url;
            } catch (e) {
              console.error('视频源设置失败:', e);
              showMobileToast('无法播放此视频源，请尝试其他剧集', 'error');
            }
          }
        } else {
          videoEl.src = url;
          
          // 恢复播放进度
          if (cachedProgress > 0) {
            videoEl.addEventListener('loadedmetadata', () => {
              videoEl.currentTime = cachedProgress;
              showMobileToast('已恢复播放进度', 'success', 2000);
            }, { once: true });
          }
        }
        
        videoEl.load();
        
        videoEl.onplaying = () => { 
          if (loadingEl) loadingEl.style.display = 'none';
          if (errorEl) errorEl.style.display = 'none';
        };
        
        videoEl.onplay = () => { 
          if (loadingEl) loadingEl.style.display = 'none'; 
          if (errorEl) errorEl.style.display = 'none'; 
        };
        
        videoEl.onerror = (e) => {
          if (loadingEl) loadingEl.style.display = 'none';
          if (errorEl) errorEl.style.display = 'block';
          showMobileToast('视频加载失败，请尝试其他剧集', 'error');
        };
        
        videoEl.oncanplay = () => {
          if (loadingEl) loadingEl.style.display = 'none'; 
          if (errorEl) errorEl.style.display = 'none';
          
          // 检测视频比例并应用相应样式
          detectAndApplyVideoAspectRatio(videoEl);
          
          // 更新视频分辨率显示
          updateVideoResolution(videoEl);
        };
        
        try {
          const playPromise = videoEl.play();
          if (playPromise !== undefined) {
            await playPromise;
            showMobileToast(`正在播放: ${buttonElement.textContent}`, 'success');
            resetRetryCount(); // 播放成功，重置重试计数
            
            // 预加载下一个剧集
            if (currentVideoData && currentVideoData.vod_play_url) {
              const playUrls = parseVodPlayUrl(currentVideoData.vod_play_url, currentVideoData.vod_play_from, currentVideoData.vod_play_note);
              preloadNextEpisode(currentMobileEpisodeIndex, playUrls);
            }
          }
        } catch (error) {
          showMobileToast('播放失败: ' + error.message, 'warning');
        }
      }
    }
    
    // 更新视频分辨率显示
    function updateVideoResolution(videoEl) {
      const resolutionBadge = document.getElementById('videoResolutionBadge');
      if (!resolutionBadge || !videoEl) return;
      
      if (videoEl.videoWidth && videoEl.videoHeight) {
        const width = videoEl.videoWidth;
        const height = videoEl.videoHeight;
        
        // 格式化分辨率显示
        let resolutionText = '';
        if (width >= 3840 && height >= 2160) {
          resolutionText = '4K';
        } else if (width >= 1920 && height >= 1080) {
          resolutionText = '1080P';
        } else if (width >= 1280 && height >= 720) {
          resolutionText = '720P';
        } else if (width >= 854 && height >= 480) {
          resolutionText = '480P';
        } else if (width >= 640 && height >= 360) {
          resolutionText = '360P';
        } else {
          resolutionText = `${width}×${height}`;
        }
        
        resolutionBadge.textContent = resolutionText;
        resolutionBadge.style.display = 'inline-block';
        
        console.log(`视频分辨率更新: ${width}×${height} (${resolutionText})`);
      } else {
        resolutionBadge.style.display = 'none';
      }
    }
    
    // 检测视频比例并应用相应样式 - 固定宽度和位置，只调整高度
    function detectAndApplyVideoAspectRatio(videoEl) {
      if (!videoEl || !videoEl.videoWidth || !videoEl.videoHeight) return;
      const aspectRatio = videoEl.videoWidth / videoEl.videoHeight;
      const isPortrait = aspectRatio < 1;
      videoEl.removeAttribute('data-aspect-ratio');
      const playerContainer = videoEl.closest('.player-container');
      if (!playerContainer) return;
      playerContainer.style.width = '100%';
      playerContainer.style.maxWidth = '100vw';
      playerContainer.style.left = '0';
      playerContainer.style.top = '0';
      playerContainer.style.position = 'relative';
      const videoSection = playerContainer.closest('.player-video-section');
      if (videoSection) {
        videoSection.style.width = '100%';
        videoSection.style.maxWidth = '100vw';
        videoSection.style.flexShrink = '0';
      }
      if (isPortrait) {
        videoEl.setAttribute('data-aspect-ratio', 'portrait');
        const containerWidth = playerContainer.offsetWidth;
        const videoHeight = containerWidth / aspectRatio;
        const isMobile = window.innerWidth <= 1023;
        const maxHeightPercent = isMobile ? 0.6 : 0.8;
        const maxHeight = Math.min(videoHeight, window.innerHeight * maxHeightPercent);
        playerContainer.style.height = `${maxHeight}px`;
        playerContainer.style.maxHeight = isMobile ? '60vh' : '80vh';
      } else {
        videoEl.setAttribute('data-aspect-ratio', 'landscape');
        const containerWidth = playerContainer.offsetWidth;
        const targetAspectRatio = aspectRatio > 2 ? 2 : aspectRatio; // 强制最大2:1
        const videoHeight = containerWidth / targetAspectRatio;
        const isMobile = window.innerWidth <= 1023;
        const maxHeightPercent = isMobile ? 0.5 : 0.7;
        const maxHeight = Math.min(videoHeight, window.innerHeight * maxHeightPercent);
        playerContainer.style.height = `${maxHeight}px`;
        playerContainer.style.maxHeight = isMobile ? '50vh' : '70vh';
      }
      playerContainer.setAttribute('data-video-aspect-ratio', aspectRatio.toString());
      playerContainer.setAttribute('data-video-is-portrait', isPortrait.toString());
    }
    
        // 窗口大小变化时重新适配视频比例 - 保持宽度和位置固定
    function handleVideoResize() {
      const videoEl = document.getElementById('playerVideoMobile');
      const playerContainer = document.querySelector('.player-container');
      
      if (videoEl && playerContainer && videoEl.videoWidth && videoEl.videoHeight) {
        // 如果视频已经加载，重新应用比例适配
        detectAndApplyVideoAspectRatio(videoEl);
      } else if (playerContainer) {
        // 如果视频还没加载，但有保存的比例信息，使用保存的信息重新适配
        const savedAspectRatio = playerContainer.getAttribute('data-video-aspect-ratio');
        const savedIsPortrait = playerContainer.getAttribute('data-video-is-portrait');
        
        if (savedAspectRatio && savedIsPortrait) {
          const aspectRatio = parseFloat(savedAspectRatio);
          const isPortrait = savedIsPortrait === 'true';
          const containerWidth = playerContainer.offsetWidth;
          const isMobile = window.innerWidth <= 1023;
          
          // 确保容器宽度和位置固定
          playerContainer.style.width = '100%';
          playerContainer.style.left = '0';
          playerContainer.style.top = '0';
          playerContainer.style.position = 'relative';
          
          // 确保播放器区域宽度固定
          const videoSection = playerContainer.closest('.player-video-section');
          if (videoSection) {
            videoSection.style.width = '100%';
            videoSection.style.maxWidth = '100%';
            videoSection.style.flexShrink = '0';
          }
          
          if (isPortrait) {
            const videoHeight = containerWidth / aspectRatio;
            const maxHeightPercent = isMobile ? 0.6 : 0.8;
            const maxHeight = Math.min(videoHeight, window.innerHeight * maxHeightPercent);
            // 只设置高度，不改变宽度和位置
            playerContainer.style.height = `${maxHeight}px`;
          } else {
            const targetAspectRatio = aspectRatio > 2 ? 2 : aspectRatio;
            const videoHeight = containerWidth / targetAspectRatio;
            const maxHeightPercent = isMobile ? 0.5 : 0.7;
            const maxHeight = Math.min(videoHeight, window.innerHeight * maxHeightPercent);
            // 只设置高度，不改变宽度和位置
            playerContainer.style.height = `${maxHeight}px`;
          }
        }
      }
    }
    
    // 使用HLS.js播放 - 参照index.html的简化实现
    function playMobileWithHlsJs(url, videoEl, loadingEl, errorEl, cachedProgress = 0) {
      if (typeof Hls === 'undefined') {
        showMobileToast('HLS.js未加载，无法播放HLS流', 'error');
        return;
      }
      
      if (!Hls.isSupported()) {
        showMobileToast('当前浏览器不支持HLS.js', 'error');
        return;
      }
      
      // 参照index.html的简化配置
      const hls = new Hls({
        debug: false,
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 30,
        maxBufferLength: 60,
        maxMaxBufferLength: 120,
        maxBufferSize: 60 * 1000 * 1000, // 60MB
        maxBufferHole: 0.5,
        highBufferWatchdogPeriod: 2,
        nudgeOffset: 0.2,
        nudgeMaxRetry: 5,
        maxFragLookUpTolerance: 0.25,
        liveSyncDurationCount: 3,
        liveMaxLatencyDurationCount: 10,
        enableSoftwareAES: true,
        enableStashBuffer: true,
        stashInitialSize: 384 * 1024, // 384KB
        enableDateRangeMetadataCues: true,
        enableEmsgMetadataCues: true,
        enableID3MetadataCues: true,
        enableWebVTT: true,
        enableIMSC1: true,
        enableCEA708Captions: true
      });
      
      window._mobileHlsInstance = hls;
      playerCache.video.hlsInstance = hls;
      
      hls.loadSource(url);
      hls.attachMedia(videoEl);
      
      hls.on(Hls.Events.MANIFEST_PARSED, function() {
        console.log('HLS清单解析完成');
            if (loadingEl) loadingEl.style.display = 'none';
            if (errorEl) errorEl.style.display = 'none';
            
        // 恢复播放进度
        if (cachedProgress > 0) {
          videoEl.currentTime = cachedProgress;
          showMobileToast('已恢复播放进度', 'success', 2000);
            }
            
            videoEl.play().then(() => {
          console.log('HLS流开始播放');
          showMobileToast('HLS流开始播放', 'success');
              resetRetryCount(); // 播放成功，重置重试计数
              
              // 检测视频比例并应用相应样式
              detectAndApplyVideoAspectRatio(videoEl);
              
              // 延迟更新分辨率，确保视频元数据已加载
              setTimeout(() => {
                updateVideoResolution(videoEl);
              }, 1000);
            }).catch(error => {
              console.error('HLS播放失败:', error);
              showMobileToast('HLS播放失败: ' + error.message, 'warning');
            });
          });
          
      hls.on(Hls.Events.BUFFER_APPENDING, function(event, data) {
        console.log('HLS缓冲追加中...');
          });
          
      hls.on(Hls.Events.BUFFER_APPENDED, function(event, data) {
        console.log('HLS缓冲追加完成');
          });
          
      hls.on(Hls.Events.BUFFER_EOS, function(event, data) {
        console.log('HLS缓冲结束');
      });
      
      hls.on(Hls.Events.ERROR, function (event, data) {
        console.error('HLS播放错误:', data);
            
        // 检查播放器是否已经关闭
        const playerLayer = document.getElementById('playerLayerMobile');
        if (playerLayer && playerLayer.style.display === 'none') {
          return; // 如果播放器已关闭，不显示错误消息
        }
        
        if (data.fatal) {
          switch(data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
              showMobileToast('HLS网络错误，请检查网络连接', 'error');
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              showMobileToast('HLS媒体错误，视频源可能有问题', 'error');
              break;
            default:
              showMobileToast('HLS播放失败: ' + (data.details || '未知错误'), 'error');
              break;
          }
            } else {
              // 非致命错误，尝试恢复
          console.warn('HLS非致命错误:', data.details);
              if (data.details === 'bufferStalledError') {
                showMobileToast('网络不稳定，正在尝试恢复...', 'warning', 3000);
                setTimeout(() => {
                  if (videoEl.paused) {
                    videoEl.play().catch(e => {
                      console.error('恢复播放失败:', e);
                      autoRetryVideo();
                    });
                  }
                }, 1000);
              }
            }
          });
    }
    
    // 移动端视频优化设置 - 简化版本
    function setupMobileVideoOptimization(videoEl) {
      // 设置视频缓存优化
      videoEl.preload = 'auto';
      
      // Safari特定优化
      if (/^((?!chrome|android).)*safari/i.test(navigator.userAgent)) {
        videoEl.setAttribute('webkit-playsinline', 'true');
        videoEl.setAttribute('playsinline', 'true');
        videoEl.setAttribute('x-webkit-airplay', 'allow');
        videoEl.setAttribute('webkit-airplay', 'allow');
        videoEl.setAttribute('airplay', 'allow');
        
        // 添加AirPlay相关事件监听
        videoEl.addEventListener('webkitbeginfullscreen', () => handleAirPlayFullscreen(videoEl));
        videoEl.addEventListener('webkitendfullscreen', () => handleAirPlayEndFullscreen(videoEl));
        videoEl.addEventListener('webkitpresentationmodechanged', () => handleAirPlayModeChanged(videoEl));
        videoEl.setAttribute('airplay', 'allow');
        
        // 添加AirPlay相关事件监听
        videoEl.addEventListener('webkitbeginfullscreen', () => handleAirPlayFullscreen(videoEl));
        videoEl.addEventListener('webkitendfullscreen', () => handleAirPlayEndFullscreen(videoEl));
        videoEl.addEventListener('webkitpresentationmodechanged', () => handleAirPlayModeChanged(videoEl));
      }
      
      // Chrome特定优化
      if (/chrome/i.test(navigator.userAgent)) {
        videoEl.setAttribute('playsinline', 'true');
      }
      
      // 通用优化
      videoEl.setAttribute('crossorigin', 'anonymous');
    }
    
    // 移动端视频错误处理
    function handleMobileVideoError(videoEl) {
      const loadingEl = document.getElementById('videoLoadingMobile');
      const errorEl = document.getElementById('videoErrorMobile');
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) errorEl.style.display = 'block';
      console.error('移动端视频加载失败:', videoEl.src);
    }
    
    // 移动端视频开始加载
    function handleMobileVideoLoadStart(videoEl) {
      const loadingEl = document.getElementById('videoLoadingMobile');
      const errorEl = document.getElementById('videoErrorMobile');
      if (loadingEl) loadingEl.style.display = 'block';
      if (errorEl) errorEl.style.display = 'none';
    }
    
    // 移动端视频可以播放
    function handleMobileVideoCanPlay(videoEl) {
      const loadingEl = document.getElementById('videoLoadingMobile');
      if (loadingEl) loadingEl.style.display = 'none';
      
      // 更新视频分辨率显示
      updateVideoResolution(videoEl);
    }
    
    // 重试移动端视频
    function retryMobileVideo() {
      const errorEl = document.getElementById('videoErrorMobile');
      if (errorEl) errorEl.style.display = 'none';
      
      // 显示重试提示
      showMobileToast('正在重试播放...', 'info', 2000);
      
      // 重新播放当前剧集
      if (currentMobileEpisodeUrl && currentMobileEpisodeButton) {
        // 延迟一点时间再重试，给网络一些恢复时间
        setTimeout(() => {
          playMobileEpisode(currentMobileEpisodeUrl, currentMobileEpisodeButton);
        }, 1000);
      } else {
        // 如果没有保存的剧集信息，尝试重新加载当前播放器
        const videoEl = document.getElementById('playerVideoMobile');
        const iframeEl = document.getElementById('playerIframeMobile');
        if (videoEl && videoEl.style.display !== 'none') {
          videoEl.load();
          videoEl.play().catch(e => {
            console.log('重试播放失败:', e);
            showMobileToast('重试播放失败，请检查网络连接', 'error');
          });
        } else if (iframeEl && iframeEl.style.display !== 'none') {
          iframeEl.src = iframeEl.src;
        }
      }
    }
    
    // 网络状态监控 - 简化版本
    function setupNetworkMonitoring() {
      if ('connection' in navigator) {
        const connection = navigator.connection;
        
        connection.addEventListener('change', () => {
          console.log('网络状态变化:', connection.effectiveType);
          
          // 只在网络很差时显示提示
          if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
            showMobileToast('网络连接较慢，可能影响视频播放', 'warning', 3000);
          }
        });
      }
    }
    
    // 自动重试机制 - 简化版本
    let retryCount = 0;
    const maxRetries = 2;
    
    function autoRetryVideo() {
      if (retryCount < maxRetries) {
        retryCount++;
        console.log(`自动重试第 ${retryCount} 次`);
        showMobileToast(`正在重试播放 (${retryCount}/${maxRetries})`, 'warning', 2000);
        
        setTimeout(() => {
          if (currentMobileEpisodeUrl && currentMobileEpisodeButton) {
            playMobileEpisode(currentMobileEpisodeUrl, currentMobileEpisodeButton);
          }
        }, 2000);
        } else {
        retryCount = 0;
        showMobileToast('播放失败，请尝试其他剧集', 'error');
      }
    }
    
    // 重置重试计数
    function resetRetryCount() {
      retryCount = 0;
    }
    
    // 初始化播放器缓存
    function initPlayerCache() {
      console.log('初始化播放器缓存系统');
      
      // 初始化视频播放器缓存
      const videoEl = document.getElementById('playerVideoMobile');
      if (videoEl) {
        playerCache.video.element = videoEl;
        setupVideoCacheEvents(videoEl);
      }
      
      // 初始化iframe播放器缓存
      const iframeEl = document.getElementById('playerIframeMobile');
      if (iframeEl) {
        playerCache.iframe.element = iframeEl;
        setupIframeCacheEvents(iframeEl);
      }
      
      // 检查缓存支持
      checkCacheSupport();
    }
    
    // 设置视频缓存事件
    function setupVideoCacheEvents(videoEl) {
      // 保存播放进度
      videoEl.addEventListener('timeupdate', () => {
        if (playerCache.video.currentUrl) {
          playerCache.video.currentTime = videoEl.currentTime;
          playerCache.video.duration = videoEl.duration;
          
          // 每5秒保存一次进度到localStorage
          if (Math.floor(videoEl.currentTime) % 5 === 0) {
            savePlaybackProgress(playerCache.video.currentUrl, videoEl.currentTime);
          }
        }
      });
      
      // 视频可以播放时标记为就绪
      videoEl.addEventListener('canplay', () => {
        playerCache.video.isReady = true;
        console.log('视频播放器缓存就绪:', playerCache.video.currentUrl);
      });
      
      // 视频加载时保存URL
      videoEl.addEventListener('loadstart', () => {
        if (videoEl.src && videoEl.src !== playerCache.video.currentUrl) {
          playerCache.video.currentUrl = videoEl.src;
          playerCache.video.isReady = false;
          console.log('视频播放器缓存URL更新:', videoEl.src);
        }
      });
    }
    
    // 设置iframe缓存事件
    function setupIframeCacheEvents(iframeEl) {
      // iframe加载完成时标记为就绪
      iframeEl.addEventListener('load', () => {
        if (iframeEl.src && iframeEl.src !== 'about:blank') {
          playerCache.iframe.currentUrl = iframeEl.src;
          playerCache.iframe.isReady = true;
          console.log('iframe播放器缓存就绪:', iframeEl.src);
        }
      });
    }
    
    // 检查缓存支持
    function checkCacheSupport() {
      // 检查localStorage支持
      try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        console.log('✅ localStorage缓存支持正常');
      } catch (e) {
        console.warn('❌ localStorage缓存不支持:', e);
        playerCache.config.enableVideoCache = false;
        playerCache.config.enableIframeCache = false;
      }
      
      // 检查视频缓存支持
      if ('caches' in window) {
        console.log('✅ Cache API支持正常');
      } else {
        console.warn('❌ Cache API不支持');
      }
    }
    
    // 保存播放进度
    function savePlaybackProgress(url, time) {
      if (!playerCache.config.enableVideoCache) return;
      
      try {
        const progress = {
          url: url,
          time: time,
          timestamp: Date.now()
        };
        
        // 保存到localStorage
        const key = `playback_progress_${btoa(url).slice(0, 20)}`;
        localStorage.setItem(key, JSON.stringify(progress));
        
        // 清理旧的进度记录（保留最近100个）
        cleanupOldProgressRecords();
        
        console.log('播放进度已保存:', { url: url.slice(0, 50) + '...', time: time });
      } catch (e) {
        console.error('保存播放进度失败:', e);
      }
    }
    
    // 获取播放进度
    function getPlaybackProgress(url) {
      if (!playerCache.config.enableVideoCache) return 0;
      
      try {
        const key = `playback_progress_${btoa(url).slice(0, 20)}`;
        const progressStr = localStorage.getItem(key);
        
        if (progressStr) {
          const progress = JSON.parse(progressStr);
          const now = Date.now();
          const age = now - progress.timestamp;
          
          // 只返回7天内的进度记录
          if (age < 7 * 24 * 60 * 60 * 1000) {
            console.log('找到播放进度:', { url: url.slice(0, 50) + '...', time: progress.time });
            return progress.time;
          } else {
            // 删除过期的进度记录
            localStorage.removeItem(key);
          }
        }
      } catch (e) {
        console.error('获取播放进度失败:', e);
      }
      
      return 0;
    }
    
    // 清理旧的进度记录
    function cleanupOldProgressRecords() {
      try {
        const keys = Object.keys(localStorage);
        const progressKeys = keys.filter(key => key.startsWith('playback_progress_'));
        
        if (progressKeys.length > 100) {
          // 按时间戳排序，删除最旧的记录
          const progressData = progressKeys.map(key => {
            try {
              const data = JSON.parse(localStorage.getItem(key));
              return { key, timestamp: data.timestamp };
            } catch (e) {
              return { key, timestamp: 0 };
            }
          }).sort((a, b) => a.timestamp - b.timestamp);
          
          // 删除最旧的记录，只保留最近100个
          const toDelete = progressData.slice(0, progressData.length - 100);
          toDelete.forEach(item => {
            localStorage.removeItem(item.key);
          });
          
          console.log('清理了', toDelete.length, '个旧的播放进度记录');
        }
      } catch (e) {
        console.error('清理播放进度记录失败:', e);
      }
    }
    
    // 预加载下一个剧集
    function preloadNextEpisode(currentIndex, playUrls) {
      if (!playerCache.config.preloadNextEpisode) return;
      
      const nextIndex = currentIndex + 1;
      if (nextIndex < playUrls.length) {
        const nextEpisode = playUrls[nextIndex];
        console.log('预加载下一个剧集:', nextEpisode.name);
        
        // 预加载视频
        if (nextEpisode.url) {
          const mediaType = detectMediaTypeSync(nextEpisode.url);
          if (mediaType === 'hls' || mediaType === 'video') {
            preloadVideo(nextEpisode.url);
          }
        }
      }
    }
    
    // 预加载视频
    function preloadVideo(url) {
      try {
        // 创建隐藏的video元素进行预加载
        const preloadVideo = document.createElement('video');
        preloadVideo.style.display = 'none';
        preloadVideo.preload = 'metadata';
        preloadVideo.muted = true;
        preloadVideo.src = url;
        
        // 预加载完成后移除元素
        preloadVideo.addEventListener('loadedmetadata', () => {
          console.log('视频预加载完成:', url.slice(0, 50) + '...');
          document.body.removeChild(preloadVideo);
        });
        
        preloadVideo.addEventListener('error', () => {
          console.log('视频预加载失败:', url.slice(0, 50) + '...');
          document.body.removeChild(preloadVideo);
        });
        
        document.body.appendChild(preloadVideo);
      } catch (e) {
        console.error('预加载视频失败:', e);
      }
    }
    
    // 清理移动端播放器
    function cleanupMobilePlayer() {
      // 保存当前播放进度
      if (playerCache.video.currentUrl && playerCache.video.element) {
        savePlaybackProgress(playerCache.video.currentUrl, playerCache.video.element.currentTime);
      }
      
      // 清理HLS实例
      if (window._mobileHlsInstance) {
        window._mobileHlsInstance.destroy();
        window._mobileHlsInstance = null;
      }
      
      if (playerCache.video.hlsInstance) {
        playerCache.video.hlsInstance.destroy();
        playerCache.video.hlsInstance = null;
      }
      
      // 清理视频元素
      const videoEl = document.getElementById('playerVideoMobile');
      if (videoEl) {
          videoEl.pause();
          videoEl.src = '';
          videoEl.load();
          // 移除所有事件监听器
          videoEl.onerror = null;
          videoEl.onloadstart = null;
          videoEl.oncanplay = null;
          videoEl.onended = null;
          videoEl.ontimeupdate = null;
          videoEl.onplaying = null;
          videoEl.onplay = null;
          videoEl.onpause = null;
          videoEl.onwaiting = null;
          videoEl.onstalled = null;
      }
      
      // 清理iframe元素
      const iframeEl = document.getElementById('playerIframeMobile');
      if (iframeEl) {
          iframeEl.src = 'about:blank';
      }
      
      // 重置缓存状态
      playerCache.video.currentUrl = null;
      playerCache.video.isReady = false;
      playerCache.iframe.currentUrl = null;
      playerCache.iframe.isReady = false;
      
      // 重置状态
      currentMobileEpisodeUrl = null;
      currentMobileEpisodeButton = null;
      currentMobileEpisodeType = null;
      currentMobileEpisodeIndex = 0;
    }
    
    // 关闭播放层并显示搜索层
    function hidePlayerLayer() {
      const playerLayer = document.getElementById('playerLayerMobile');
      if (playerLayer) {
        console.log('关闭播放层，准备显示搜索层');
        
        // 清理播放器
        cleanupMobilePlayer();
        
        // 隐藏播放层
        playerLayer.classList.remove('slide-in');
        playerLayer.classList.add('slide-out');
        
        // 隐藏返回按钮
        hideGlobalBackBtn();
        
        // 动画结束后隐藏播放层并显示搜索层
        setTimeout(() => {
        playerLayer.style.display = 'none';
          playerLayer.classList.remove('slide-out');
          
          // 显示搜索层
          showSearchResultsLayer();
          
          // 重置播放器相关状态
          currentMobileEpisodeUrl = null;
          currentMobileEpisodeButton = null;
          currentMobileEpisodeType = null;
          currentMobileEpisodeIndex = 0;
        }, 350);
      }
    }
    
    // =====================================================
    
    // ================== 移动端HLS和AirPlay支持检查 ==================
    
    // 检查移动端HLS支持
    function checkMobileHlsSupport() {
      console.log('=== 移动端HLS支持检查 ===');
      
      // 检查HLS.js是否可用
      if (typeof Hls !== 'undefined') {
        console.log('✅ HLS.js已加载');
        if (Hls.isSupported()) {
          console.log('✅ HLS.js支持当前浏览器');
        } else {
          console.log('❌ HLS.js不支持当前浏览器');
        }
      } else {
        console.log('❌ HLS.js未加载');
      }
      
      // 检查原生HLS支持
      const video = document.createElement('video');
      if (video.canPlayType('application/vnd.apple.mpegurl')) {
        console.log('✅ 浏览器原生支持HLS');
      } else {
        console.log('❌ 浏览器原生不支持HLS');
      }
      
      // 检查浏览器类型
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isChrome = /chrome/i.test(navigator.userAgent);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      
      console.log('浏览器信息:', {
        isSafari: isSafari,
        isChrome: isChrome,
        isMobile: isMobile,
        userAgent: navigator.userAgent
      });
      
      if (isSafari) {
        console.log('🖥️ Safari浏览器检测到，原生HLS和AirPlay功能可用');
      } else if (isChrome) {
        console.log('🌐 Chrome浏览器检测到，需要HLS.js支持HLS流');
      }
      
      if (isMobile) {
        console.log('📱 移动设备检测到，优化移动端播放体验');
      }
    }
    
    // 检查移动端Safari AirPlay支持
    function checkMobileSafariAirPlay() {
      console.log('=== 移动端AirPlay支持检查 ===');
      
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.platform);
      
      if (isSafari || isIOS) {
        console.log('✅ Safari/iOS检测到，AirPlay功能应该可用');
        
        // 检查视频元素是否支持AirPlay
        const video = document.createElement('video');
        if (video.webkitSupportsPresentationMode) {
          console.log('✅ 视频元素支持AirPlay演示模式');
        }
        
        // 检查是否支持AirPlay
        if (video.webkitSupportsPresentationMode && 
            video.webkitSupportsPresentationMode('picture-in-picture')) {
          console.log('✅ 支持画中画模式');
        }
      } else {
        console.log('❌ 非Safari/iOS设备，AirPlay功能不可用');
      }
    }
    
    // =====================================================

    // AirPlay相关事件处理，增强TV端遥控器兼容性
    function handleAirPlayFullscreen(videoEl) {
      console.log('AirPlay进入全屏，TV端遥控器可用');
    }
    function handleAirPlayEndFullscreen(videoEl) {
      console.log('AirPlay退出全屏，TV端遥控器不可用');
    }
    function handleAirPlayModeChanged(videoEl) {
      console.log('AirPlay模式变化', videoEl.webkitPresentationMode);
    }

    // 遥控器常用控制事件监听
    function addRemoteControlListeners(videoEl) {
      if (!videoEl) return;
      videoEl.addEventListener('play', () => { console.log('遥控器：播放'); });
      videoEl.addEventListener('pause', () => { console.log('遥控器：暂停'); });
      videoEl.addEventListener('seeking', () => { console.log('遥控器：快进/快退中'); });
      videoEl.addEventListener('seeked', () => { console.log('遥控器：快进/快退完成'); });
      videoEl.addEventListener('volumechange', () => { console.log('遥控器：音量变化'); });
      videoEl.addEventListener('ratechange', () => { console.log('遥控器：播放速度变化'); });
      videoEl.addEventListener('fullscreenchange', () => { console.log('遥控器：全屏状态变化'); });
      videoEl.addEventListener('webkitpresentationmodechanged', () => { console.log('遥控器：AirPlay模式变化'); });
    }

    // 页面初始化时自动为播放器添加遥控器事件监听
    document.addEventListener('DOMContentLoaded', function() {
      var videoEl = document.getElementById('playerVideoMobile');
      addRemoteControlListeners(videoEl);
      
      // 初始化播放器容器固定属性
      initializePlayerContainer();
      
      // 添加窗口大小变化监听，重新适配视频比例
      window.addEventListener('resize', function() {
        // 使用防抖，避免频繁调用
        clearTimeout(window.videoResizeTimer);
        window.videoResizeTimer = setTimeout(handleVideoResize, 200);
      });
      
      // 添加屏幕方向变化监听（移动端）
      window.addEventListener('orientationchange', function() {
        // 屏幕方向变化时延迟重新适配，等待布局完成
        setTimeout(handleVideoResize, 500);
      });
      
      // 监听媒体查询变化，确保PC端和移动端切换时播放器宽度固定
      const mediaQuery = window.matchMedia('(min-width: 1024px)');
      mediaQuery.addEventListener('change', function(e) {
        // 布局变化时重新确保播放器宽度固定
        setTimeout(function() {
          const playerContainer = document.querySelector('.player-container');
          const videoSection = document.querySelector('.player-video-section');
          
          if (playerContainer) {
            playerContainer.style.width = '100%';
            playerContainer.style.left = '0';
            playerContainer.style.top = '0';
            playerContainer.style.position = 'relative';
          }
          
          if (videoSection) {
            videoSection.style.width = '100%';
            videoSection.style.maxWidth = '100%';
            videoSection.style.flexShrink = '0';
          }
          
          console.log('布局变化检测：已重新固定播放器宽度');
        }, 100);
      });
    });
    
    // 初始化播放器容器固定属性
    function initializePlayerContainer() {
      const playerContainer = document.querySelector('.player-container');
      if (playerContainer) {
        // 确保容器宽度和位置固定
        playerContainer.style.width = '100%';
        playerContainer.style.left = '0';
        playerContainer.style.top = '0';
        playerContainer.style.position = 'relative';
        playerContainer.style.minHeight = '220px';
        
        // 确保播放器区域宽度固定
        const videoSection = playerContainer.closest('.player-video-section');
        if (videoSection) {
          videoSection.style.width = '100%';
          videoSection.style.maxWidth = '100%';
          videoSection.style.flexShrink = '0';
        }
        
        console.log('播放器容器初始化完成：宽度和位置已固定');
      }
    }

    // 播放器显示与异常处理优化
    function showVideoPlayer() {
      const videoEl = document.getElementById('playerVideoMobile');
      const iframeEl = document.getElementById('playerIframeMobile');
      const playerContainer = videoEl && videoEl.parentElement;
      if (videoEl) {
        videoEl.style.display = 'block';
        videoEl.style.visibility = 'visible';
      }
      if (iframeEl) {
        iframeEl.style.display = 'none';
        iframeEl.style.visibility = 'hidden';
      }
      if (playerContainer) {
        playerContainer.style.minHeight = '200px';
        playerContainer.style.aspectRatio = '16/9';
        playerContainer.style.background = '#18192b';
      }
    }
    function showIframePlayer() {
      const videoEl = document.getElementById('playerVideoMobile');
      const iframeEl = document.getElementById('playerIframeMobile');
      const playerContainer = videoEl && videoEl.parentElement;
      if (videoEl) {
        videoEl.style.display = 'none';
        videoEl.style.visibility = 'hidden';
      }
      if (iframeEl) {
        iframeEl.style.display = 'block';
        iframeEl.style.visibility = 'visible';
      }
      if (playerContainer) {
        playerContainer.style.minHeight = '200px';
        playerContainer.style.aspectRatio = '16/9';
        playerContainer.style.background = '#18192b';
      }
    }
    function showPlayerError(msg) {
      const errorEl = document.getElementById('videoErrorMobile');
      const loadingEl = document.getElementById('videoLoadingMobile');
      const videoEl = document.getElementById('playerVideoMobile');
      const iframeEl = document.getElementById('playerIframeMobile');
      const playerContainer = videoEl && videoEl.parentElement;
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) {
        errorEl.style.display = 'block';
        errorEl.querySelector('div').textContent = msg || '⚠️ 视频加载失败';
      }
      if (videoEl) {
        videoEl.style.display = 'none';
        videoEl.style.visibility = 'hidden';
      }
      if (iframeEl) {
        iframeEl.style.display = 'none';
        iframeEl.style.visibility = 'hidden';
      }
      if (playerContainer) {
        playerContainer.style.minHeight = '200px';
        playerContainer.style.aspectRatio = '16/9';
        playerContainer.style.background = '#18192b';
      }
    }
    // 在playMobileEpisode、handleMobileVideoError、playMobileWithHlsJs等相关函数中调用上述方法，确保状态切换时布局始终整洁。
    // ... existing code ...

    document.addEventListener('DOMContentLoaded', function() {
      // ... existing code ...
      // 阻止视频源列表滚动冒泡
      var sourcesListSidebar = document.getElementById('sourcesListSidebar');
      if (sourcesListSidebar) {
        sourcesListSidebar.addEventListener('touchmove', function(e) {
          e.stopPropagation();
        }, { passive: false });
        sourcesListSidebar.addEventListener('wheel', function(e) {
          e.stopPropagation();
        }, { passive: false });
      }
    });

    // 顶部标题和关于按钮点击跳转到 about.html
    function initHeaderTitleClick() {
      var headerTitle = document.getElementById('headerTitle');
      var aboutBtn = document.getElementById('aboutBtn');
      
      if(headerTitle){
        // 移除可能存在的旧事件监听器
        headerTitle.removeEventListener('click', headerTitle._clickHandler);
        headerTitle.removeEventListener('mouseenter', headerTitle._mouseenterHandler);
        headerTitle.removeEventListener('mouseleave', headerTitle._mouseleaveHandler);
        
        // 创建新的事件处理函数
        headerTitle._clickHandler = function(e){
          e.preventDefault();
          e.stopPropagation();
          console.log('标题被点击，准备在新窗口打开 /about');
          window.open('/about', '_blank');
        };
        
        headerTitle._mouseenterHandler = function(){
          headerTitle.style.color = '#6c63ff';
        };
        
        headerTitle._mouseleaveHandler = function(){
          headerTitle.style.color = '#fff';
        };
        
        // 添加事件监听器
        headerTitle.addEventListener('click', headerTitle._clickHandler);
        headerTitle.addEventListener('mouseenter', headerTitle._mouseenterHandler);
        headerTitle.addEventListener('mouseleave', headerTitle._mouseleaveHandler);
        
        console.log('标题点击事件已绑定，元素:', headerTitle);
      } else {
        console.error('未找到标题元素 headerTitle');
      }
      
      if(aboutBtn){
        // 移除可能存在的旧事件监听器
        aboutBtn.removeEventListener('click', aboutBtn._clickHandler);
        
        // 创建新的事件处理函数
        aboutBtn._clickHandler = function(e){
          e.preventDefault();
          e.stopPropagation();
          console.log('关于按钮被点击，准备在新窗口打开 /about');
          window.open('/about', '_blank');
        };
        
        // 添加事件监听器
        aboutBtn.addEventListener('click', aboutBtn._clickHandler);
        
        console.log('关于按钮点击事件已绑定，元素:', aboutBtn);
      } else {
        console.error('未找到关于按钮元素 aboutBtn');
      }
    }
    
    // 确保在DOM加载完成后执行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHeaderTitleClick);
    } else {
      initHeaderTitleClick();
    }
    
    // 额外确保在页面完全加载后再次尝试绑定
    window.addEventListener('load', function() {
      setTimeout(initHeaderTitleClick, 100);
    });
  </script>
  </body>
  </html>